<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    {% include 'v3/partials/_head.html' %}
</head>
<body x-data="app()" class="bg-gray-50 min-h-screen">
    <!-- Header -->
    {% include 'v3/partials/_header.html' %}

    <!-- Desktop sidebar -->
    <aside class="sidebar d-none d-lg-block">
        {% include 'v3/partials/_sidebar_nav.html' %}
    </aside>

    <!-- Mobile offcanvas sidebar -->
    <div class="offcanvas offcanvas-start" tabindex="-1" id="sidebarOffcanvas"
         style="width: 260px; background-color: var(--lm-surface-card);">
        <div class="offcanvas-header border-bottom" style="border-color: var(--lm-border) !important;">
            <h5 class="offcanvas-title" style="font-family: 'DM Sans', sans-serif;">
                <i class="fas fa-tv me-2" style="color: var(--lm-primary);"></i>Navigation
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body p-0">
            {% include 'v3/partials/_sidebar_nav.html' %}
        </div>
    </div>

    <!-- Main content -->
    <main class="main-content" style="padding-top: 56px;">
        <div class="container-fluid p-3 p-lg-4">

        <!-- Tab content -->
        <div id="tab-content" class="space-y-6">
            <!-- Overview tab -->
            <div x-show="activeTab === 'overview'" x-transition>
                <div id="overview-content" hx-get="/v3/partials/overview" hx-trigger="revealed" hx-swap="innerHTML" hx-on::htmx:response-error="loadOverviewDirect()">
                    <div class="placeholder-glow">
                        <div class="card mb-3">
                            <div class="card-body">
                                <span class="placeholder col-4 mb-3"></span>
                                <span class="placeholder col-7"></span>
                                <span class="placeholder col-12" style="height: 120px;"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <script>
                // Fallback: Load overview content directly if HTMX fails
                function loadOverviewDirect() {
                    const overviewContent = document.getElementById('overview-content');
                    if (overviewContent && !overviewContent.hasAttribute('data-loaded')) {
                        fetch('/v3/partials/overview')
                            .then(response => response.text())
                            .then(html => {
                                overviewContent.innerHTML = html;
                                overviewContent.setAttribute('data-loaded', 'true');
                                // Re-initialize Alpine.js for the new content
                                if (window.Alpine) {
                                    window.Alpine.initTree(overviewContent);
                                }
                            })
                            .catch(err => {
                                console.error('Failed to load overview content:', err);
                                overviewContent.innerHTML = '<div class="bg-red-50 border border-red-200 rounded-lg p-4"><p class="text-red-800">Failed to load overview page. Please refresh the page.</p></div>';
                            });
                    }
                }
                
                // Listen for HTMX load failure
                window.addEventListener('htmx-load-failed', function() {
                    console.warn('HTMX failed to load, setting up direct content loading fallbacks');
                    // Try to load content directly after a delay
                    setTimeout(() => {
                        const appElement = document.querySelector('[x-data="app()"]');
                        if (appElement && appElement.__x) {
                            const activeTab = appElement.__x.$data.activeTab || 'overview';
                            if (activeTab === 'overview') {
                                loadOverviewDirect();
                            }
                        }
                    }, 2000);
                });
                
                // Also try direct load if HTMX doesn't load within 5 seconds
                setTimeout(() => {
                    if (typeof htmx === 'undefined') {
                        console.warn('HTMX not loaded after 5 seconds, using direct fetch for content');
                        const appElement = document.querySelector('[x-data="app()"]');
                        if (appElement && appElement.__x) {
                            const activeTab = appElement.__x.$data.activeTab || 'overview';
                            if (activeTab === 'overview') {
                                loadOverviewDirect();
                            }
                        }
                    }
                }, 5000);
            </script>

            <!-- General tab -->
            <div x-show="activeTab === 'general'" x-transition>
                <div id="general-content" hx-get="/v3/partials/general" hx-trigger="revealed" hx-swap="innerHTML">
                    <div class="placeholder-glow">
                        <div class="card mb-3">
                            <div class="card-body">
                                <span class="placeholder col-4 mb-3"></span>
                                <span class="placeholder col-7"></span>
                                <span class="placeholder col-12" style="height: 120px;"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- WiFi tab -->
            <div x-show="activeTab === 'wifi'" x-transition>
                <div id="wifi-content"
                     hx-get="/v3/partials/wifi"
                     hx-trigger="revealed"
                     hx-swap="innerHTML"
                     hx-on::htmx:response-error="loadWifiDirect()">
                    <div class="placeholder-glow">
                        <div class="card mb-3">
                            <div class="card-body">
                                <span class="placeholder col-4 mb-3"></span>
                                <span class="placeholder col-7"></span>
                                <span class="placeholder col-12" style="height: 120px;"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <script>
                // Fallback: Load WiFi content directly if HTMX fails
                function loadWifiDirect() {
                    const wifiContent = document.getElementById('wifi-content');
                    if (wifiContent && !wifiContent.hasAttribute('data-loaded')) {
                        fetch('/v3/partials/wifi')
                            .then(response => response.text())
                            .then(html => {
                                wifiContent.innerHTML = html;
                                wifiContent.setAttribute('data-loaded', 'true');
                                // Re-initialize Alpine.js for the new content
                                if (window.Alpine) {
                                    window.Alpine.initTree(wifiContent);
                                }
                            })
                            .catch(err => {
                                console.error('Failed to load WiFi content:', err);
                                wifiContent.innerHTML = '<div class="bg-red-50 border border-red-200 rounded-lg p-4"><p class="text-red-800">Failed to load WiFi setup page. Please refresh the page.</p></div>';
                            });
                    }
                }
                
                // Also try direct load if HTMX doesn't load within 3 seconds (AP mode detection)
                setTimeout(() => {
                    const isAPMode = window.location.hostname === '192.168.4.1' || 
                                   window.location.hostname.startsWith('192.168.4.');
                    if (isAPMode && typeof htmx === 'undefined') {
                        console.warn('HTMX not loaded, using direct fetch for WiFi content');
                        loadWifiDirect();
                    }
                }, 3000);
            </script>

            <!-- Schedule tab -->
            <div x-show="activeTab === 'schedule'" x-transition>
                <div id="schedule-content" hx-get="/v3/partials/schedule" hx-trigger="revealed" hx-swap="innerHTML">
                    <div class="placeholder-glow">
                        <div class="card mb-3">
                            <div class="card-body">
                                <span class="placeholder col-4 mb-3"></span>
                                <span class="placeholder col-7"></span>
                                <span class="placeholder col-12" style="height: 120px;"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Display tab -->
            <div x-show="activeTab === 'display'" x-transition>
                <div id="display-content" hx-get="/v3/partials/display" hx-trigger="revealed" hx-swap="innerHTML">
                    <div class="placeholder-glow">
                        <div class="card mb-3">
                            <div class="card-body">
                                <span class="placeholder col-4 mb-3"></span>
                                <span class="placeholder col-7"></span>
                                <span class="placeholder col-12" style="height: 120px;"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Config Editor tab -->
            <div x-show="activeTab === 'config-editor'" x-transition>
                <div id="config-editor-content" hx-get="/v3/partials/raw-json" hx-trigger="revealed" hx-swap="innerHTML">
                    <div class="placeholder-glow">
                        <div class="card mb-3">
                            <div class="card-body">
                                <span class="placeholder col-4 mb-3"></span>
                                <span class="placeholder col-7"></span>
                                <span class="placeholder col-12" style="height: 120px;"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Plugins tab -->
            <div x-show="activeTab === 'plugins'" 
                 x-transition
                 x-effect="if (activeTab === 'plugins') { window.loadPluginsTab && window.loadPluginsTab(); }">
                <div id="plugins-content">
                    <div class="placeholder-glow">
                        <div class="card mb-3">
                            <div class="card-body">
                                <span class="placeholder col-4 mb-3"></span>
                                <span class="placeholder col-7"></span>
                                <span class="placeholder col-12" style="height: 120px;"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Fonts tab -->
            <div x-show="activeTab === 'fonts'" x-transition>
                <div id="fonts-content" hx-get="/v3/partials/fonts" hx-trigger="revealed" hx-swap="innerHTML">
                    <div class="placeholder-glow">
                        <div class="card mb-3">
                            <div class="card-body">
                                <span class="placeholder col-4 mb-3"></span>
                                <span class="placeholder col-7"></span>
                                <span class="placeholder col-12" style="height: 120px;"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Logs tab -->
            <div x-show="activeTab === 'logs'" x-transition>
                <div id="logs-content" hx-get="/v3/partials/logs" hx-trigger="revealed" hx-swap="innerHTML">
                    <div class="placeholder-glow">
                        <div class="card mb-3">
                            <div class="card-body">
                                <span class="placeholder col-4 mb-3"></span>
                                <span class="placeholder col-7"></span>
                                <span class="placeholder col-12" style="height: 120px;"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cache tab -->
            <div x-show="activeTab === 'cache'" x-transition>
                <div id="cache-content" hx-get="/v3/partials/cache" hx-trigger="revealed" hx-swap="innerHTML">
                    <div class="placeholder-glow">
                        <div class="card mb-3">
                            <div class="card-body">
                                <span class="placeholder col-4 mb-3"></span>
                                <span class="placeholder col-7"></span>
                                <span class="placeholder col-12" style="height: 120px;"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Operation History tab -->
            <div x-show="activeTab === 'operation-history'" x-transition>
                <div id="operation-history-content" hx-get="/v3/partials/operation-history" hx-trigger="revealed" hx-swap="innerHTML">
                    <div class="placeholder-glow">
                        <div class="card mb-3">
                            <div class="card-body">
                                <span class="placeholder col-4 mb-3"></span>
                                <span class="placeholder col-7"></span>
                                <span class="placeholder col-12" style="height: 120px;"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dynamic Plugin Tabs - HTMX Lazy Loading -->
            <!-- 
                Architecture: Server-side rendered plugin configuration forms
                - Each plugin tab loads its config via HTMX when first viewed
                - Forms are generated server-side using Jinja2 macros
                - Reduces client-side complexity and improves performance
                - Uses x-init to trigger HTMX after Alpine renders the element
            -->
            <template x-for="plugin in installedPlugins" :key="plugin.id">
                <div x-show="activeTab === plugin.id" x-transition>
                    <!-- Only load content when tab is active (lazy loading) -->
                    <template x-if="activeTab === plugin.id">
                        <div class="bg-white rounded-lg shadow p-6 plugin-config-tab"
                             :id="'plugin-config-' + plugin.id"
                             x-init="$nextTick(() => { 
                                 if (window.htmx && !$el.dataset.htmxLoaded) {
                                     $el.dataset.htmxLoaded = 'true';
                                     htmx.ajax('GET', '/v3/partials/plugin-config/' + plugin.id, {target: $el, swap: 'innerHTML'});
                                 }
                             })">
                            <!-- Loading skeleton shown until HTMX loads server-rendered content -->
                            <div class="placeholder-glow">
                                <div class="card mb-3">
                                    <div class="card-body">
                                        <span class="placeholder col-4 mb-3"></span>
                                        <span class="placeholder col-7"></span>
                                        <span class="placeholder col-12" style="height: 120px;"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </template>
        </div>
        </div>
    </main>

    {% include 'v3/partials/_scripts.html' %}
</body>
</html>

