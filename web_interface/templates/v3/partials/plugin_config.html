{# Plugin Configuration Partial - Server-side rendered form #}
{# This template is loaded via HTMX when a plugin tab is clicked #}

{# ===== MACROS FOR FORM FIELD GENERATION ===== #}

{# Render a single form field based on schema type #}
{% macro render_field(key, prop, value, prefix='', plugin_id='') %}
    {% set full_key = (prefix ~ '.' ~ key) if prefix else key %}
    {% set field_id = (plugin_id ~ '-' ~ full_key)|replace('.', '-')|replace('_', '-') %}
    {% set label = prop.title if prop.title else key|replace('_', ' ')|title %}
    {% set description = prop.description if prop.description else '' %}
    {% set field_type = prop.type if prop.type is string else (prop.type[0] if prop.type is iterable else 'string') %}

    {# Handle nested objects - check for widget first #}
    {% if field_type == 'object' %}
        {% set obj_widget = prop.get('x-widget') or prop.get('x_widget') %}
        {% if obj_widget == 'schedule-picker' %}
            {# Schedule picker widget - renders enable/mode/times UI #}
            {% set obj_value = value if value is not none else {} %}
            <div class="mb-3">
                <label class="form-label fw-medium">{{ label }}</label>
                {% if description %}<div class="form-text mb-2">{{ description }}</div>{% endif %}
                <div id="{{ field_id }}_container" class="schedule-picker-container mt-1"></div>
                <input type="hidden" id="{{ field_id }}_data" name="{{ full_key }}" value='{{ (obj_value|tojson|safe)|replace("'", "&#39;") }}'>
            </div>
            <script>
            (function() {
                function initWidget() {
                    if (!window.LEDMatrixWidgets) { setTimeout(initWidget, 50); return; }
                    var widget = window.LEDMatrixWidgets.get('schedule-picker');
                    if (!widget) { setTimeout(initWidget, 50); return; }
                    var container = document.getElementById('{{ field_id }}_container');
                    if (!container) return;
                    var value = {{ obj_value|tojson|safe }};
                    var config = { 'x-options': {{ (prop.get('x-options') or prop.get('x_options') or {})|tojson|safe }} };
                    widget.render(container, config, value, { fieldId: '{{ field_id }}', pluginId: '{{ plugin_id }}' });
                }
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', initWidget);
                } else {
                    setTimeout(initWidget, 50);
                }
            })();
            </script>
        {% elif obj_widget == 'time-range' %}
            {# Time range widget - renders start/end time inputs #}
            {% set obj_value = value if value is not none else {} %}
            <div class="mb-3">
                <label class="form-label fw-medium">{{ label }}</label>
                {% if description %}<div class="form-text mb-2">{{ description }}</div>{% endif %}
                <div id="{{ field_id }}_container" class="time-range-container mt-1"></div>
                <input type="hidden" id="{{ field_id }}_data" name="{{ full_key }}" value='{{ (obj_value|tojson|safe)|replace("'", "&#39;") }}'>
            </div>
            <script>
            (function() {
                function initWidget() {
                    if (!window.LEDMatrixWidgets) { setTimeout(initWidget, 50); return; }
                    var widget = window.LEDMatrixWidgets.get('time-range');
                    if (!widget) { setTimeout(initWidget, 50); return; }
                    var container = document.getElementById('{{ field_id }}_container');
                    if (!container) return;
                    var value = {{ obj_value|tojson|safe }};
                    var config = { 'x-options': {{ (prop.get('x-options') or prop.get('x_options') or {})|tojson|safe }} };
                    widget.render(container, config, value, { fieldId: '{{ field_id }}', pluginId: '{{ plugin_id }}' });
                }
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', initWidget);
                } else {
                    setTimeout(initWidget, 50);
                }
            })();
            </script>
        {% elif prop.properties %}
            {{ render_nested_section(key, prop, value, prefix, plugin_id) }}
        {% endif %}
    {% else %}
        <div class="mb-3">
            <label for="{{ field_id }}" class="form-label fw-medium">
                {{ label }}
            </label>

            {% if description %}
            <div class="form-text mb-2">{{ description }}</div>
            {% endif %}

            {# Boolean - check for widget first #}
            {% if field_type == 'boolean' %}
            {% set bool_widget = prop.get('x-widget') or prop.get('x_widget') %}
            {% if bool_widget == 'toggle-switch' %}
                {# Render toggle-switch widget #}
                <div id="{{ field_id }}_container" class="toggle-switch-container"></div>
                <script>
                (function() {
                    function initWidget() {
                        if (!window.LEDMatrixWidgets) { setTimeout(initWidget, 50); return; }
                        var widget = window.LEDMatrixWidgets.get('toggle-switch');
                        if (!widget) { setTimeout(initWidget, 50); return; }
                        var container = document.getElementById('{{ field_id }}_container');
                        if (!container) return;
                        var value = {{ value|tojson|safe if value is not none else 'false' }};
                        var config = {
                            'type': 'boolean',
                            'x-options': {{ (prop.get('x-options') or prop.get('x_options') or {})|tojson|safe }}
                        };
                        widget.render(container, config, value, { fieldId: '{{ field_id }}', name: '{{ full_key }}', pluginId: '{{ plugin_id }}' });
                    }
                    if (document.readyState === 'loading') {
                        document.addEventListener('DOMContentLoaded', initWidget);
                    } else {
                        setTimeout(initWidget, 50);
                    }
                })();
                </script>
            {% else %}
            {# Default checkbox - value="true" ensures checked sends "true" not "on" #}
            <div class="form-check form-switch">
                <input type="checkbox"
                       id="{{ field_id }}"
                       name="{{ full_key }}"
                       value="true"
                       {% if value %}checked{% endif %}
                       class="form-check-input">
                <label class="form-check-label" for="{{ field_id }}">Enabled</label>
            </div>
            {% endif %}

            {# Enum dropdown #}
            {% elif prop.enum %}
            <select id="{{ field_id }}"
                    name="{{ full_key }}"
                    class="form-select">
                {% for option in prop.enum %}
                <option value="{{ option }}" {% if value == option %}selected{% endif %}>
                    {{ option|replace('_', ' ')|title }}
                </option>
                {% endfor %}
            </select>

            {# Number input - check for widget first #}
            {% elif field_type in ['number', 'integer'] %}
            {% set num_widget = prop.get('x-widget') or prop.get('x_widget') %}
            {% if num_widget in ['slider', 'number-input'] %}
                {# Render slider or number-input widget #}
                <div id="{{ field_id }}_container" class="{{ num_widget }}-container"></div>
                <script>
                (function() {
                    function initWidget() {
                        if (!window.LEDMatrixWidgets) { setTimeout(initWidget, 50); return; }
                        var widget = window.LEDMatrixWidgets.get('{{ num_widget }}');
                        if (!widget) { setTimeout(initWidget, 50); return; }
                        var container = document.getElementById('{{ field_id }}_container');
                        if (!container) return;
                        var value = {{ value|tojson if value is not none else (prop.default|tojson if prop.default is defined else 'null') }};
                        var config = {
                            'type': '{{ field_type }}',
                            'minimum': {{ prop.minimum|tojson if prop.minimum is defined else 'null' }},
                            'maximum': {{ prop.maximum|tojson if prop.maximum is defined else 'null' }},
                            'x-options': {{ (prop.get('x-options') or prop.get('x_options') or {})|tojson|safe }}
                        };
                        widget.render(container, config, value, { fieldId: '{{ field_id }}', name: '{{ full_key }}', pluginId: '{{ plugin_id }}' });
                    }
                    if (document.readyState === 'loading') {
                        document.addEventListener('DOMContentLoaded', initWidget);
                    } else {
                        setTimeout(initWidget, 50);
                    }
                })();
                </script>
            {% else %}
            {# Default number input #}
            <input type="number"
                   id="{{ field_id }}"
                   name="{{ full_key }}"
                   value="{{ value if value is not none else (prop.default if prop.default is defined else '') }}"
                   {% if prop.minimum is defined %}min="{{ prop.minimum }}"{% endif %}
                   {% if prop.maximum is defined %}max="{{ prop.maximum }}"{% endif %}
                   {% if field_type == 'integer' %}step="1"{% else %}step="any"{% endif %}
                   class="form-control">
            {% endif %}

            {# Array - check for file upload widget first (to avoid breaking static-image plugin), then checkbox-group, then array of objects #}
            {% elif field_type == 'array' %}
            {% set x_widget = prop.get('x-widget') or prop.get('x_widget') %}
            {% if x_widget == 'file-upload' %}
                {# File upload widget for arrays #}
                {% set upload_config = prop.get('x-upload-config') or {} %}
                {% set max_files = upload_config.get('max_files', 10) %}
                {% set allowed_types = upload_config.get('allowed_types', ['image/png', 'image/jpeg', 'image/bmp', 'image/gif']) %}
                {% set max_size_mb = upload_config.get('max_size_mb', 5) %}
                {% set plugin_id_from_config = upload_config.get('plugin_id', plugin_id) %}
                {% set array_value = value if value is not none and value is iterable and value is not string else (prop.default if prop.default is defined and prop.default is iterable and prop.default is not string else []) %}

                <div id="{{ field_id }}_upload_widget" class="mt-1">
                    <!-- File Upload Drop Zone -->
                    <div id="{{ field_id }}_drop_zone"
                         class="border border-2 border-dashed rounded-3 p-4 text-center cursor-pointer"
                         ondrop="window.handleFileDrop(event, this.dataset.fieldId)"
                         ondragover="event.preventDefault()"
                         data-field-id="{{ field_id }}"
                         onclick="document.getElementById('{{ field_id }}_file_input').click()">
                        <input type="file"
                               id="{{ field_id }}_file_input"
                               multiple
                               accept="{{ allowed_types|join(',') }}"
                               style="display: none;"
                               data-field-id="{{ field_id }}"
                               onchange="window.handleFileSelect(event, this.dataset.fieldId)">
                        <i class="fas fa-cloud-upload-alt fs-3 text-muted mb-2"></i>
                        <p class="small text-muted mb-1">Drag and drop images here or click to browse</p>
                        <p class="small text-muted mb-0">Max {{ max_files }} files, {{ max_size_mb }}MB each (PNG, JPG, GIF, BMP)</p>
                    </div>
                    <div class="form-text text-warning mt-2 d-flex align-items-center">
                        <i class="fas fa-info-circle me-1"></i>
                        Remember to save configuration after upload
                    </div>

                    <!-- Uploaded Images List -->
                    <div id="{{ field_id }}_image_list" class="mt-3">
                        {% for img in array_value %}
                        {% set img_id = img.get('id', loop.index0) %}
                        {% set img_schedule = img.get('schedule', {}) %}
                        {% set has_schedule = img_schedule.get('enabled', false) and img_schedule.get('mode') and img_schedule.get('mode') != 'always' %}
                        <div id="img_{{ img_id|string|replace('.', '_')|replace('-', '_') }}" class="card bg-light mb-2">
                            <div class="card-body p-2">
                                <div class="d-flex align-items-center justify-content-between mb-2">
                                    <div class="d-flex align-items-center gap-3 flex-grow-1">
                                        <img src="/{{ img.get('path', '') }}"
                                             alt="{{ img.get('filename', '') }}"
                                             class="rounded" style="width: 4rem; height: 4rem; object-fit: cover;"
                                             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                                        <div style="display:none; width: 4rem; height: 4rem;" class="bg-secondary bg-opacity-25 rounded d-flex align-items-center justify-content-center">
                                            <i class="fas fa-image text-muted"></i>
                                        </div>
                                        <div class="flex-grow-1 text-truncate">
                                            <p class="small fw-medium mb-0 text-truncate">{{ img.get('original_filename') or img.get('filename', 'Image') }}</p>
                                            <p class="small text-muted mb-0">
                                                {% if img.get('size') %}{{ (img.get('size') / 1024)|round }} KB{% endif %}
                                                {% if img.get('uploaded_at') %} &bull; {{ img.get('uploaded_at') }}{% endif %}
                                            </p>
                                            {% if has_schedule %}
                                            <p class="small text-primary mt-1 mb-0">
                                                <i class="fas fa-clock me-1"></i>Scheduled
                                            </p>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-center gap-1 ms-3">
                                        <button type="button"
                                                data-field-id="{{ field_id }}"
                                                data-image-id="{{ img_id }}"
                                                data-image-idx="{{ loop.index0 }}"
                                                onclick="window.openImageSchedule(this.dataset.fieldId, this.dataset.imageId || null, parseInt(this.dataset.imageIdx))"
                                                class="btn btn-sm btn-link text-primary p-1"
                                                title="Schedule this image">
                                            <i class="fas fa-calendar-alt"></i>
                                        </button>
                                        <button type="button"
                                                data-field-id="{{ field_id }}"
                                                data-image-id="{{ img_id }}"
                                                data-plugin-id="{{ plugin_id_from_config }}"
                                                onclick="window.deleteUploadedImage(this.dataset.fieldId, this.dataset.imageId, this.dataset.pluginId)"
                                                class="btn btn-sm btn-link text-danger p-1"
                                                title="Delete image">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <div id="schedule_{{ img_id|string|replace('.', '_')|replace('-', '_') }}" class="d-none mt-2 pt-2 border-top"></div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Hidden input to store image data -->
                    <input type="hidden" id="{{ field_id }}_images_data" name="{{ full_key }}" value='{{ (array_value|tojson|safe)|replace("'", "&#39;") }}'>
                </div>
            {% elif x_widget == 'checkbox-group' %}
                {# Checkbox group widget for multi-select arrays with enum items #}
                {% set array_value = value if value is not none and value is iterable and value is not string else (prop.default if prop.default is defined and prop.default is iterable and prop.default is not string else []) %}
                {% set items_schema = prop.get('items') or {} %}
                {% set enum_items = items_schema.get('enum') or [] %}
                {% set x_options = prop.get('x-options') or {} %}
                {% set labels = x_options.get('labels') or {} %}

                <div class="mt-1">
                    {% for option in enum_items %}
                    {% set is_checked = option in array_value %}
                    {% set option_label = labels.get(option, option|replace('_', ' ')|title) %}
                    {% set checkbox_id = (field_id ~ '_' ~ option)|replace('.', '_')|replace(' ', '_') %}
                    <div class="form-check mb-2">
                        <input type="checkbox"
                               id="{{ checkbox_id }}"
                               name="{{ full_key }}[]"
                               data-checkbox-group="{{ field_id }}"
                               data-option-value="{{ option }}"
                               value="{{ option }}"
                               {% if is_checked %}checked{% endif %}
                               onchange="updateCheckboxGroupData('{{ field_id }}')"
                               class="form-check-input">
                        <label class="form-check-label" for="{{ checkbox_id }}">{{ option_label }}</label>
                    </div>
                    {% endfor %}
                </div>
                {# Hidden input to store selected values as JSON array (like array-of-objects pattern) #}
                <input type="hidden" id="{{ field_id }}_data" name="{{ full_key }}_data" value='{{ (array_value|tojson|safe)|replace("'", "&#39;") }}'>
                {# Sentinel hidden input with bracket notation to allow clearing array to [] when all unchecked #}
                {# This ensures the field is always submitted, even when all checkboxes are unchecked #}
                <input type="hidden" name="{{ full_key }}[]" value="">
            {% elif x_widget == 'day-selector' %}
                {# Day selector widget for selecting days of the week #}
                {% set array_value = value if value is not none and value is iterable and value is not string else (prop.default if prop.default is defined and prop.default is iterable and prop.default is not string else []) %}
                <div id="{{ field_id }}_container" class="day-selector-container mt-1"></div>
                <script>
                (function() {
                    function initWidget() {
                        if (!window.LEDMatrixWidgets) { setTimeout(initWidget, 50); return; }
                        var widget = window.LEDMatrixWidgets.get('day-selector');
                        if (!widget) { setTimeout(initWidget, 50); return; }
                        var container = document.getElementById('{{ field_id }}_container');
                        if (!container) return;
                        var value = {{ array_value|tojson|safe }};
                        var config = { 'x-options': {{ (prop.get('x-options') or prop.get('x_options') or {})|tojson|safe }} };
                        widget.render(container, config, value, { fieldId: '{{ field_id }}', pluginId: '{{ plugin_id }}', name: '{{ full_key }}' });
                    }
                    if (document.readyState === 'loading') {
                        document.addEventListener('DOMContentLoaded', initWidget);
                    } else {
                        setTimeout(initWidget, 50);
                    }
                })();
                </script>
            {% else %}
                {# Check for custom-feeds widget first #}
                {% set items_schema = prop.get('items') or {} %}
                {% if x_widget == 'custom-feeds' %}
                    {# Custom feeds table interface - widget-specific implementation #}
                    {# Validate that required fields exist in schema #}
                    {% set item_properties = items_schema.get('properties', {}) %}
                    {% if not (item_properties.get('name') and item_properties.get('url')) %}
                        {# Fallback to generic if schema doesn't match expected structure #}
                        <div class="form-text text-warning mt-1">
                            <i class="fas fa-exclamation-triangle me-1"></i>
                            Custom feeds widget requires 'name' and 'url' properties in items schema.
                        </div>
                    {% else %}
                        {% set max_items = prop.get('maxItems', 50) %}
                        {% set array_value = value if value is not none and value is iterable and value is not string else (prop.default if prop.default is defined and prop.default is iterable and prop.default is not string else []) %}

                        <div class="custom-feeds-table-container mt-1">
                            <div class="table-responsive">
                            <table class="table table-bordered table-sm align-middle mb-2">
                                <thead class="table-light">
                                    <tr>
                                        <th class="small text-uppercase text-muted">Name</th>
                                        <th class="small text-uppercase text-muted">URL</th>
                                        <th class="small text-uppercase text-muted">Logo</th>
                                        <th class="small text-uppercase text-muted text-center">Enabled</th>
                                        <th class="small text-uppercase text-muted text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="{{ field_id }}_tbody">
                                    {% for item in array_value %}
                                    {% set item_index = loop.index0 %}
                                    <tr class="custom-feed-row" data-index="{{ item_index }}">
                                        <td>
                                            <input type="text"
                                                   name="{{ full_key }}.{{ item_index }}.name"
                                                   value="{{ item.get('name', '') }}"
                                                   class="form-control form-control-sm"
                                                   placeholder="Feed Name"
                                                   required>
                                        </td>
                                        <td>
                                            <input type="url"
                                                   name="{{ full_key }}.{{ item_index }}.url"
                                                   value="{{ item.get('url', '') }}"
                                                   class="form-control form-control-sm"
                                                   placeholder="https://example.com/feed"
                                                   required>
                                        </td>
                                        <td>
                                            {% set logo_value = item.get('logo') or {} %}
                                            {% set logo_path = logo_value.get('path', '') %}
                                            <div class="d-flex align-items-center gap-2">
                                                <input type="file"
                                                       id="{{ field_id }}_logo_{{ item_index }}"
                                                       accept="image/png,image/jpeg,image/bmp,image/gif"
                                                       style="display: none;"
                                                       onchange="handleCustomFeedLogoUpload(event, '{{ field_id }}', {{ item_index }}, '{{ plugin_id }}', '{{ full_key }}')">
                                                <button type="button"
                                                        onclick="document.getElementById('{{ field_id }}_logo_{{ item_index }}').click()"
                                                        class="btn btn-sm btn-light">
                                                    <i class="fas fa-upload me-1"></i> Upload
                                                </button>
                                                {% if logo_path %}
                                                <img src="/{{ logo_path }}" alt="Logo" class="rounded border" style="width: 2rem; height: 2rem; object-fit: cover;" id="{{ field_id }}_logo_preview_{{ item_index }}">
                                                <input type="hidden" name="{{ full_key }}.{{ item_index }}.logo.path" value="{{ logo_path }}">
                                                <input type="hidden" name="{{ full_key }}.{{ item_index }}.logo.id" value="{{ logo_value.get('id', '') }}">
                                                {% else %}
                                                <span class="small text-muted">No logo</span>
                                                {% endif %}
                                            </div>
                                        </td>
                                        <td class="text-center">
                                            <input type="hidden" name="{{ full_key }}.{{ item_index }}.enabled" value="false">
                                            <div class="form-check form-switch d-flex justify-content-center">
                                                <input type="checkbox"
                                                       name="{{ full_key }}.{{ item_index }}.enabled"
                                                       {% if item.get('enabled', true) %}checked{% endif %}
                                                       value="true"
                                                       class="form-check-input">
                                            </div>
                                        </td>
                                        <td class="text-center">
                                            <button type="button"
                                                    onclick="removeCustomFeedRow(this)"
                                                    class="btn btn-sm btn-link text-danger p-1">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                            </div>
                            <button type="button"
                                    onclick="addCustomFeedRow('{{ field_id }}', '{{ full_key }}', {{ max_items }}, '{{ plugin_id }}')"
                                    class="btn btn-primary btn-sm"
                                    {% if array_value|length >= max_items %}disabled style="opacity: 0.5;"{% endif %}>
                                <i class="fas fa-plus me-1"></i> Add Feed
                            </button>
                        </div>
                    {% endif %}
                {% elif x_widget == 'array-table' %}
                    {# Generic array-of-objects table widget - reads columns from schema #}
                    {% set item_properties = items_schema.get('properties', {}) %}
                    {% set max_items = prop.get('maxItems', 50) %}
                    {% set array_value = value if value is not none and value is iterable and value is not string else (prop.default if prop.default is defined and prop.default is iterable and prop.default is not string else []) %}

                    {# Use x-columns if specified, otherwise auto-detect first 4 simple properties #}
                    {% set x_columns = prop.get('x-columns') %}
                    {% if x_columns %}
                        {% set display_columns = x_columns %}
                    {% else %}
                        {% set display_columns = [] %}
                        {% for col_name in item_properties.keys() %}
                            {% set col_def = item_properties[col_name] %}
                            {% if col_def.get('type') not in ['object', 'array'] and display_columns|length < 4 %}
                                {% set _ = display_columns.append(col_name) %}
                            {% endif %}
                        {% endfor %}
                    {% endif %}

                    <div class="array-table-container mt-1" data-field-id="{{ field_id }}" data-full-key="{{ full_key }}" data-max-items="{{ max_items }}" data-plugin-id="{{ plugin_id }}">
                        <div class="table-responsive">
                        <table class="table table-bordered table-sm align-middle mb-2">
                            <thead class="table-light">
                                <tr>
                                    {% for col_name in display_columns %}
                                        {% set col_def = item_properties.get(col_name, {}) %}
                                        {% set col_title = col_def.get('title', col_name|replace('_', ' ')|title) %}
                                        <th class="small text-uppercase text-muted">{{ col_title }}</th>
                                    {% endfor %}
                                    <th class="small text-uppercase text-muted text-center" style="width: 5rem;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="{{ field_id }}_tbody">
                                {% for item in array_value %}
                                {% set item_index = loop.index0 %}
                                <tr class="array-table-row" data-index="{{ item_index }}">
                                    {% for col_name in display_columns %}
                                        {% set col_def = item_properties.get(col_name, {}) %}
                                        {% set col_type = col_def.get('type', 'string') %}
                                        {% set col_value = item.get(col_name, col_def.get('default', '')) %}
                                        <td>
                                            {% if col_type == 'boolean' %}
                                                <input type="hidden" name="{{ full_key }}.{{ item_index }}.{{ col_name }}" value="false">
                                                <div class="form-check form-switch d-flex justify-content-center">
                                                    <input type="checkbox"
                                                           name="{{ full_key }}.{{ item_index }}.{{ col_name }}"
                                                           {% if col_value %}checked{% endif %}
                                                           value="true"
                                                           class="form-check-input">
                                                </div>
                                            {% elif col_type == 'integer' or col_type == 'number' %}
                                                <input type="number"
                                                       name="{{ full_key }}.{{ item_index }}.{{ col_name }}"
                                                       value="{{ col_value if col_value is not none else '' }}"
                                                       {% if col_def.get('minimum') is not none %}min="{{ col_def.get('minimum') }}"{% endif %}
                                                       {% if col_def.get('maximum') is not none %}max="{{ col_def.get('maximum') }}"{% endif %}
                                                       {% if col_type == 'integer' %}step="1"{% else %}step="any"{% endif %}
                                                       class="form-control form-control-sm text-center" style="width: 5rem;"
                                                       {% if col_def.get('description') %}title="{{ col_def.get('description') }}"{% endif %}>
                                            {% else %}
                                                <input type="text"
                                                       name="{{ full_key }}.{{ item_index }}.{{ col_name }}"
                                                       value="{{ col_value if col_value is not none else '' }}"
                                                       class="form-control form-control-sm"
                                                       {% if col_def.get('description') %}placeholder="{{ col_def.get('description') }}"{% endif %}
                                                       {% if col_def.get('pattern') %}pattern="{{ col_def.get('pattern') }}"{% endif %}
                                                       {% if col_def.get('minLength') %}minlength="{{ col_def.get('minLength') }}"{% endif %}
                                                       {% if col_def.get('maxLength') %}maxlength="{{ col_def.get('maxLength') }}"{% endif %}>
                                            {% endif %}
                                        </td>
                                    {% endfor %}
                                    <td class="text-center">
                                        <button type="button"
                                                onclick="removeArrayTableRow(this)"
                                                class="btn btn-sm btn-link text-danger p-1">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        </div>
                        <button type="button"
                                onclick="addArrayTableRow(this)"
                                data-field-id="{{ field_id }}"
                                data-full-key="{{ full_key }}"
                                data-max-items="{{ max_items }}"
                                data-plugin-id="{{ plugin_id }}"
                                data-item-properties="{{ item_properties|tojson|e }}"
                                data-display-columns="{{ display_columns|tojson|e }}"
                                class="btn btn-primary btn-sm"
                                {% if array_value|length >= max_items %}disabled style="opacity: 0.5;"{% endif %}>
                            <i class="fas fa-plus me-1"></i> Add Item
                        </button>
                    </div>
                {% else %}
                    {# Generic array-of-objects would go here if needed in the future #}
                    {# For now, fall back to regular array input (comma-separated) #}
                    {# Regular array input (comma-separated) #}
                    {% set array_value = value if value is not none else (prop.default if prop.default is defined else []) %}
                    <input type="text"
                           id="{{ field_id }}"
                           name="{{ full_key }}"
                           value="{{ array_value|join(', ') if array_value is iterable and array_value is not string else '' }}"
                           placeholder="Enter values separated by commas"
                           class="form-control">
                    <div class="form-text">Separate multiple values with commas</div>
                {% endif %}
            {% endif %}

            {# String/default field - check for widgets #}
            {% else %}
            {% set str_widget = prop.get('x-widget') or prop.get('x_widget') %}
            {% set str_value = value if value is not none else (prop.default if prop.default is defined else '') %}
            {% if str_widget in ['text-input', 'textarea', 'select-dropdown', 'toggle-switch', 'radio-group', 'date-picker', 'slider', 'color-picker', 'email-input', 'url-input', 'password-input', 'font-selector'] %}
                {# Render widget container #}
                <div id="{{ field_id }}_container" class="{{ str_widget }}-container"></div>
                <script>
                (function() {
                    function initWidget() {
                        if (!window.LEDMatrixWidgets) { setTimeout(initWidget, 50); return; }
                        var widget = window.LEDMatrixWidgets.get('{{ str_widget }}');
                        if (!widget) { setTimeout(initWidget, 50); return; }
                        var container = document.getElementById('{{ field_id }}_container');
                        if (!container) return;
                        var value = {{ str_value|tojson|safe }};
                        var config = {
                            'type': '{{ field_type }}',
                            'enum': {{ (prop.enum or [])|tojson|safe }},
                            'minimum': {{ prop.minimum|tojson if prop.minimum is defined else 'null' }},
                            'maximum': {{ prop.maximum|tojson if prop.maximum is defined else 'null' }},
                            'x-options': {{ (prop.get('x-options') or prop.get('x_options') or {})|tojson|safe }}
                        };
                        widget.render(container, config, value, { fieldId: '{{ field_id }}', name: '{{ full_key }}', pluginId: '{{ plugin_id }}' });
                    }
                    if (document.readyState === 'loading') {
                        document.addEventListener('DOMContentLoaded', initWidget);
                    } else {
                        setTimeout(initWidget, 50);
                    }
                })();
                </script>
            {% else %}
                {# Default text input #}
                <input type="text"
                       id="{{ field_id }}"
                       name="{{ full_key }}"
                       value="{{ str_value }}"
                       class="form-control">
            {% endif %}
            {% endif %}
        </div>
    {% endif %}
{% endmacro %}

{# Render a nested/collapsible section for object types #}
{% macro render_nested_section(key, prop, value, prefix='', plugin_id='') %}
    {% set full_key = (prefix ~ '.' ~ key) if prefix else key %}
    {% set section_id = (plugin_id ~ '-section-' ~ full_key)|replace('.', '-')|replace('_', '-') %}
    {% set label = prop.title if prop.title else key|replace('_', ' ')|title %}
    {% set description = prop.description if prop.description else '' %}
    {% set nested_value = value if value else {} %}

    <div class="card bg-light mb-3">
        <div class="card-header p-0 border-0">
            <button type="button"
                    class="btn btn-light w-100 d-flex align-items-center justify-content-between text-start rounded-top"
                    onclick="toggleSection('{{ section_id }}')">
                <div class="flex-grow-1">
                    <h6 class="fw-semibold mb-0">{{ label }}</h6>
                    {% if description %}
                    <div class="small text-muted mt-1">{{ description }}</div>
                    {% endif %}
                </div>
                <i id="{{ section_id }}-icon" class="fas fa-chevron-right text-muted transition-transform"></i>
            </button>
        </div>
        <div id="{{ section_id }}" class="card-body d-none" style="display: none;">
            {% set property_order = prop['x-propertyOrder'] if 'x-propertyOrder' in prop else prop.properties.keys()|list %}
            {% for nested_key in property_order %}
                {% if nested_key in prop.properties %}
                    {% set nested_prop = prop.properties[nested_key] %}
                    {% set nested_val = nested_value[nested_key] if nested_key in nested_value else none %}
                    {{ render_field(nested_key, nested_prop, nested_val, full_key, plugin_id) }}
                {% endif %}
            {% endfor %}
        </div>
    </div>
{% endmacro %}

{# ===== MAIN TEMPLATE ===== #}

<div class="plugin-config-container"
     data-plugin-id="{{ plugin.id }}"
     x-data="{ saving: false, saveError: null, saveSuccess: false }">

    <div class="border-bottom pb-3 mb-4">
        <div class="d-flex align-items-center justify-content-between">
            <div>
                <h2 class="h5 fw-semibold mb-1">{{ plugin.name or plugin.id }}</h2>
                <p class="text-muted small mb-0">{{ plugin.description or 'Plugin configuration' }}</p>
            </div>
            <div class="d-flex align-items-center gap-3">
                <div class="form-check form-switch">
                    <input type="checkbox"
                           id="plugin-enabled-{{ plugin.id }}"
                           name="enabled"
                           value="true"
                           {% if plugin.enabled %}checked{% endif %}
                           hx-post="/api/v3/plugins/toggle?plugin_id={{ plugin.id }}"
                           hx-trigger="change"
                           hx-swap="none"
                           hx-vals='js:{enabled: document.getElementById("plugin-enabled-{{ plugin.id }}").checked ? "true" : "false"}'
                           hx-on::after-request="handleToggleResponse(event, '{{ plugin.id }}')"
                           class="form-check-input">
                    <label class="form-check-label small {% if plugin.enabled %}text-success{% else %}text-muted{% endif %}" for="plugin-enabled-{{ plugin.id }}">
                        {% if plugin.enabled %}Enabled{% else %}Disabled{% endif %}
                    </label>
                </div>
            </div>
        </div>
    </div>

    <form id="plugin-config-form-{{ plugin.id }}"
          hx-post="/api/v3/plugins/config?plugin_id={{ plugin.id }}"
          hx-trigger="submit"
          hx-swap="none"
          hx-indicator="#save-indicator-{{ plugin.id }}"
          hx-on::before-request="this.querySelector('[type=submit]').disabled = true"
          hx-on::after-request="handleConfigSave(event, '{{ plugin.id }}')"
          onsubmit="return validatePluginConfigForm(this, '{{ plugin.id }}');">

        <div class="row g-3">
            {# Plugin Information Panel #}
            <div class="col-md-6">
                <div class="card bg-light h-100">
                    <div class="card-body">
                        <h6 class="fw-bold mb-3">Plugin Information</h6>
                        <dl class="mb-0">
                            <div class="mb-2">
                                <dt class="small fw-medium text-muted">Name</dt>
                                <dd class="small mb-0">{{ plugin.name or plugin.id }}</dd>
                            </div>
                            <div class="mb-2">
                                <dt class="small fw-medium text-muted">Author</dt>
                                <dd class="small mb-0">{{ plugin.author or 'Unknown' }}</dd>
                            </div>
                            {% if plugin.version %}
                            <div class="mb-2">
                                <dt class="small fw-medium text-muted">Version</dt>
                                <dd class="small mb-0">{{ plugin.version }}</dd>
                            </div>
                            {% endif %}
                            {% if plugin.last_commit %}
                            <div class="mb-2">
                                <dt class="small fw-medium text-muted">Commit</dt>
                                <dd class="small mb-0 font-monospace">
                                    {{ plugin.last_commit[:7] if plugin.last_commit|length > 7 else plugin.last_commit }}
                                    {% if plugin.branch %}
                                    <span class="text-muted">({{ plugin.branch }})</span>
                                    {% endif %}
                                </dd>
                            </div>
                            {% endif %}
                            {% if plugin.category %}
                            <div class="mb-2">
                                <dt class="small fw-medium text-muted">Category</dt>
                                <dd class="small mb-0">{{ plugin.category }}</dd>
                            </div>
                            {% endif %}
                            {% if plugin.tags %}
                            <div class="mb-2">
                                <dt class="small fw-medium text-muted">Tags</dt>
                                <dd class="d-flex flex-wrap gap-1 mt-1 mb-0">
                                    {% for tag in plugin.tags %}
                                    <span class="badge bg-primary bg-opacity-10 text-primary">{{ tag }}</span>
                                    {% endfor %}
                                </dd>
                            </div>
                            {% endif %}
                        </dl>

                        {# On-Demand Controls #}
                        <div class="mt-3 pt-3 border-top">
                            <div class="d-flex align-items-center gap-2 mb-2">
                                <i class="fas fa-bolt text-primary"></i>
                                <span class="small fw-semibold">On-Demand Controls</span>
                            </div>
                            <div class="d-flex flex-wrap gap-2">
                                <button type="button"
                                        onclick="runPluginOnDemand('{{ plugin.id }}')"
                                        class="btn btn-success btn-sm d-flex align-items-center gap-1">
                                    <i class="fas fa-play-circle"></i>
                                    <span>Run On-Demand</span>
                                </button>
                                <button type="button"
                                        onclick="stopOnDemand()"
                                        class="btn btn-danger btn-sm d-flex align-items-center gap-1">
                                    <i class="fas fa-stop"></i>
                                    <span>Stop On-Demand</span>
                                </button>
                            </div>
                            {% if not plugin.enabled %}
                            <div class="form-text text-warning mt-2">Plugin is disabled, but on-demand will temporarily enable it.</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            {# Configuration Form Panel #}
            <div class="col-md-6">
                <div class="card bg-light h-100">
                    <div class="card-body">
                        <h6 class="fw-bold mb-3">Configuration</h6>
                        <div style="max-height: 24rem; overflow-y: auto;" class="pe-2">
                            {% if schema and schema.properties %}
                                {# Use property order if defined, otherwise use natural order #}
                                {# Skip 'enabled' field - it's handled by the header toggle #}
                                {% set property_order = schema['x-propertyOrder'] if 'x-propertyOrder' in schema else schema.properties.keys()|list %}
                                {% for key in property_order %}
                                    {% if key in schema.properties and key != 'enabled' %}
                                        {% set prop = schema.properties[key] %}
                                        {% set value = config[key] if key in config else none %}
                                        {{ render_field(key, prop, value, '', plugin.id) }}
                                    {% endif %}
                                {% endfor %}
                            {% else %}
                                {# No schema - render simple form from config #}
                                {% if config %}
                                    {% for key, value in config.items() %}
                                        {% if key not in ['enabled'] %}
                                        <div class="mb-3">
                                            <label class="form-label fw-medium">
                                                {{ key|replace('_', ' ')|title }}
                                            </label>
                                            {% if value is sameas true or value is sameas false %}
                                            <div class="form-check form-switch">
                                                <input type="checkbox" name="{{ key }}" {% if value %}checked{% endif %}
                                                       class="form-check-input">
                                                <label class="form-check-label">Enabled</label>
                                            </div>
                                            {% elif value is number %}
                                            <input type="number" name="{{ key }}" value="{{ value }}"
                                                   class="form-control">
                                            {% else %}
                                            <input type="text" name="{{ key }}" value="{{ value }}"
                                                   class="form-control">
                                            {% endif %}
                                        </div>
                                        {% endif %}
                                    {% endfor %}
                                {% else %}
                                    <p class="text-muted small">No configuration options available for this plugin.</p>
                                {% endif %}
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {# Web UI Actions (if any) #}
        {% if web_ui_actions %}
        <div class="mt-4 pt-3 border-top">
            <h6 class="fw-bold mb-3">Plugin Actions</h6>
            {% if web_ui_actions[0].section_description %}
            <p class="small text-muted mb-3">{{ web_ui_actions[0].section_description }}</p>
            {% endif %}
            <div class="d-grid gap-2">
                {% for action in web_ui_actions %}
                {% set action_id = "action-" ~ action.id ~ "-" ~ loop.index0 %}
                {% set status_id = "action-status-" ~ action.id ~ "-" ~ loop.index0 %}
                {% set bg_color = action.color or 'blue' %}
                {% if bg_color == 'green' %}
                    {% set alert_class = 'alert-success' %}
                    {% set btn_class = 'btn-success' %}
                {% elif bg_color == 'red' %}
                    {% set alert_class = 'alert-danger' %}
                    {% set btn_class = 'btn-danger' %}
                {% elif bg_color == 'yellow' %}
                    {% set alert_class = 'alert-warning' %}
                    {% set btn_class = 'btn-warning' %}
                {% elif bg_color == 'purple' %}
                    {% set alert_class = 'alert-info' %}
                    {% set btn_class = 'btn-info' %}
                {% else %}
                    {% set alert_class = 'alert-primary' %}
                    {% set btn_class = 'btn-primary' %}
                {% endif %}
                <div class="alert {{ alert_class }} d-flex align-items-center justify-content-between mb-2">
                    <div class="flex-grow-1">
                        <h6 class="alert-heading fw-medium mb-1">
                            {% if action.icon %}<i class="{{ action.icon }} me-2"></i>{% endif %}{{ action.title or action.id }}
                        </h6>
                        <p class="small mb-0">{{ action.description or '' }}</p>
                    </div>
                    <button type="button"
                            id="{{ action_id }}"
                            onclick="executePluginAction('{{ action.id }}', {{ loop.index0 }}, '{{ plugin.id }}')"
                            data-plugin-id="{{ plugin.id }}"
                            data-action-id="{{ action.id }}"
                            class="btn {{ btn_class }} btn-sm ms-3 text-nowrap">
                        {% if action.icon %}<i class="{{ action.icon }} me-1"></i>{% endif %}{{ action.button_text or action.title or action.id }}
                    </button>
                </div>
                <div id="{{ status_id }}" class="d-none mt-1"></div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        {# Action Buttons #}
        <div class="d-flex justify-content-end gap-2 mt-4 pt-3 border-top">
            <button type="button"
                    onclick="refreshPluginConfig('{{ plugin.id }}')"
                    class="btn btn-secondary btn-sm">
                <i class="fas fa-sync-alt me-1"></i>Refresh
            </button>
            <button type="button"
                    hx-post="/api/v3/plugins/update?plugin_id={{ plugin.id }}"
                    hx-swap="none"
                    hx-on::after-request="handlePluginUpdate(event, '{{ plugin.id }}')"
                    class="btn btn-warning btn-sm">
                <i class="fas fa-download me-1"></i>Update
            </button>
            <button type="button"
                    onclick="if(confirm('Are you sure you want to uninstall {{ plugin.name or plugin.id }}?')) uninstallPlugin('{{ plugin.id }}')"
                    class="btn btn-danger btn-sm">
                <i class="fas fa-trash me-1"></i>Uninstall
            </button>
            <button type="submit" class="btn btn-primary btn-sm d-flex align-items-center">
                <span id="save-indicator-{{ plugin.id }}" class="htmx-indicator me-1">
                    <i class="fas fa-spinner fa-spin"></i>
                </span>
                <i class="fas fa-save me-1 save-icon"></i>
                <span>Save Configuration</span>
            </button>
        </div>
    </form>
</div>
