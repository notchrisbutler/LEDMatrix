<div class="card shadow-sm">
    <div class="card-header">
        <h2 class="card-title mb-1">Operation History</h2>
        <p class="card-subtitle text-muted small mb-0">View history of plugin operations and configuration changes for debugging and auditing.</p>
    </div>

    <div class="card-body">
        <!-- Controls -->
        <div class="row g-2 align-items-end mb-4">
            <div class="col-12 col-md-auto">
                <!-- Filter by Plugin -->
                <label class="form-label fw-medium small mb-1">Plugin</label>
                <select id="history-plugin-filter" class="form-select form-select-sm">
                    <option value="">All Plugins</option>
                </select>
            </div>

            <div class="col-12 col-md-auto">
                <!-- Filter by Operation Type -->
                <label class="form-label fw-medium small mb-1">Operation</label>
                <select id="history-type-filter" class="form-select form-select-sm">
                    <option value="">All Operations</option>
                    <option value="install">Install</option>
                    <option value="update">Update</option>
                    <option value="uninstall">Uninstall</option>
                    <option value="enable">Enable</option>
                    <option value="disable">Disable</option>
                    <option value="configure">Configure</option>
                </select>
            </div>

            <div class="col-12 col-md-auto">
                <!-- Filter by Status -->
                <label class="form-label fw-medium small mb-1">Status</label>
                <select id="history-status-filter" class="form-select form-select-sm">
                    <option value="">All Statuses</option>
                    <option value="success">Success</option>
                    <option value="failed">Failed</option>
                </select>
            </div>

            <div class="col-12 col-md-auto">
                <!-- Search -->
                <label class="form-label fw-medium small mb-1">Search</label>
                <div class="input-group input-group-sm">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" id="history-search" placeholder="Search operations..." class="form-control">
                </div>
            </div>

            <div class="col-12 col-md-auto ms-md-auto">
                <div class="d-flex gap-2">
                    <!-- Refresh -->
                    <button id="refresh-history-btn" class="btn btn-primary btn-sm">
                        <i class="fas fa-sync-alt me-1"></i>Refresh
                    </button>
                    <!-- Clear History -->
                    <button id="clear-history-btn" class="btn btn-outline-danger btn-sm">
                        <i class="fas fa-trash me-1"></i>Clear
                    </button>
                </div>
            </div>
        </div>

        <!-- History Table -->
        <div class="table-responsive">
            <table class="table table-sm table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Timestamp</th>
                        <th>Operation</th>
                        <th>Plugin</th>
                        <th>Status</th>
                        <th>User</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody id="history-table-body">
                    <tr>
                        <td colspan="6" class="text-center py-3 text-muted">
                            <div class="placeholder-glow">
                                <span class="placeholder col-4"></span>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div class="d-flex align-items-center justify-content-between mt-3">
            <div class="small text-muted">
                Showing <span id="history-start">0</span> to <span id="history-end">0</span> of <span id="history-total">0</span> operations
            </div>
            <div class="d-flex gap-2">
                <button id="history-prev-btn" class="btn btn-outline-secondary btn-sm" disabled>
                    <i class="fas fa-chevron-left me-1"></i>Previous
                </button>
                <button id="history-next-btn" class="btn btn-outline-secondary btn-sm" disabled>
                    Next<i class="fas fa-chevron-right ms-1"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
(function() {
    let currentPage = 1;
    const pageSize = 50;
    let allHistory = [];
    let filteredHistory = [];

    // Normalize status values so both server-side conventions match filter values.
    // The server may return "completed" or "success" for successful operations,
    // and "error" or "failed" for failures.
    function normalizeStatus(status) {
        const s = (status || '').toLowerCase();
        if (s === 'completed' || s === 'success') return 'success';
        if (s === 'error' || s === 'failed') return 'failed';
        return s;
    }

    // Load operation history
    async function loadHistory() {
        try {
            const response = await fetch('/api/v3/plugins/operation/history?limit=1000');
            const data = await response.json();

            if (data.status === 'success') {
                allHistory = data.data || [];
                applyFilters();
            } else {
                console.error('Failed to load history:', data.message);
                showError('Failed to load operation history');
            }
        } catch (error) {
            console.error('Error loading history:', error);
            showError('Error loading operation history');
        }
    }

    // Apply filters
    function applyFilters() {
        const pluginFilter = document.getElementById('history-plugin-filter')?.value || '';
        const typeFilter = document.getElementById('history-type-filter')?.value || '';
        const statusFilter = document.getElementById('history-status-filter')?.value || '';
        const searchTerm = (document.getElementById('history-search')?.value || '').toLowerCase();

        filteredHistory = allHistory.filter(record => {
            if (pluginFilter && record.plugin_id !== pluginFilter) return false;
            if (typeFilter && record.operation_type !== typeFilter) return false;
            if (statusFilter && normalizeStatus(record.status) !== statusFilter) return false;
            if (searchTerm) {
                const searchable = [
                    record.operation_type,
                    record.plugin_id,
                    record.status,
                    record.user,
                    record.error,
                    JSON.stringify(record.details || {})
                ].join(' ').toLowerCase();
                if (!searchable.includes(searchTerm)) return false;
            }
            return true;
        });

        renderHistory();
    }

    // Render history table
    function renderHistory() {
        const tbody = document.getElementById('history-table-body');
        if (!tbody) return;

        const start = (currentPage - 1) * pageSize;
        const end = Math.min(start + pageSize, filteredHistory.length);
        const pageData = filteredHistory.slice(start, end);

        if (pageData.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-3 text-muted">
                        No operations found
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = pageData.map(record => {
            const timestamp = new Date(record.timestamp || record.created_at || Date.now());
            const timeStr = timestamp.toLocaleString();
            const normalized = normalizeStatus(record.status);
            const statusBadge = getStatusBadge(normalized);
            const operationType = record.operation_type || 'unknown';
            const operationBadge = getOperationTypeBadge(operationType);
            const pluginId = record.plugin_id || '-';
            const user = record.user || '-';
            const error = record.error ? `<div class="text-danger small mt-1">${escapeHtml(record.error)}</div>` : '';

            // Build a concise details summary
            let detailsSummary = '';
            const d = record.details;
            if (d) {
                const parts = [];
                if (d.version) parts.push(`v${d.version}`);
                if (d.branch) parts.push(`branch: ${d.branch}`);
                if (d.commit) parts.push(`commit: ${String(d.commit).substring(0, 7)}`);
                if (d.previous_commit && d.commit && d.previous_commit !== d.commit) {
                    parts.push(`from: ${String(d.previous_commit).substring(0, 7)}`);
                }
                if (d.preserve_config !== undefined) parts.push(d.preserve_config ? 'config preserved' : 'config removed');
                detailsSummary = parts.length > 0 ? `<span class="small text-muted">${escapeHtml(parts.join(' | '))}</span>` : '';
            }

            return `
                <tr>
                    <td class="small">${escapeHtml(timeStr)}</td>
                    <td>${operationBadge}</td>
                    <td class="small">${escapeHtml(pluginId)}</td>
                    <td>${statusBadge}</td>
                    <td class="small text-muted">${escapeHtml(user)}</td>
                    <td class="small">
                        ${detailsSummary || '-'}
                        ${error}
                    </td>
                </tr>
            `;
        }).join('');

        // Update pagination
        document.getElementById('history-start').textContent = filteredHistory.length > 0 ? start + 1 : 0;
        document.getElementById('history-end').textContent = end;
        document.getElementById('history-total').textContent = filteredHistory.length;

        // Update pagination buttons
        const prevBtn = document.getElementById('history-prev-btn');
        const nextBtn = document.getElementById('history-next-btn');
        if (prevBtn) prevBtn.disabled = currentPage === 1;
        if (nextBtn) nextBtn.disabled = end >= filteredHistory.length;
    }

    // Helper functions
    function getStatusBadge(status) {
        if (status === 'success') return '<span class="badge bg-success">success</span>';
        if (status === 'failed') return '<span class="badge bg-danger">failed</span>';
        return `<span class="badge bg-secondary">${escapeHtml(status)}</span>`;
    }

    function getOperationTypeBadge(type) {
        const typeLower = (type || '').toLowerCase();
        const badgeMap = {
            'install': 'bg-primary',
            'update': 'bg-info text-dark',
            'uninstall': 'bg-danger',
            'enable': 'bg-success',
            'disable': 'bg-warning text-dark',
            'configure': 'bg-secondary'
        };
        const badgeClass = badgeMap[typeLower] || 'bg-secondary';
        return `<span class="badge ${badgeClass}">${escapeHtml(type)}</span>`;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function showError(message) {
        if (typeof showNotification === 'function') {
            showNotification(message, 'error');
        } else {
            alert(message);
        }
    }

    // Populate plugin filter
    async function populatePluginFilter() {
        try {
            // Use PluginAPI if available, otherwise fall back to direct fetch
            let data;
            if (window.PluginAPI && window.PluginAPI.getInstalledPlugins) {
                const plugins = await window.PluginAPI.getInstalledPlugins();
                data = { status: 'success', data: { plugins: plugins } };
            } else {
                const response = await fetch('/api/v3/plugins/installed');
                data = await response.json();
            }

            if (data.status === 'success' && data.data) {
                const select = document.getElementById('history-plugin-filter');
                if (select) {
                    const plugins = Object.keys(data.data);
                    plugins.forEach(pluginId => {
                        const option = document.createElement('option');
                        option.value = pluginId;
                        option.textContent = pluginId;
                        select.appendChild(option);
                    });
                }
            }
        } catch (error) {
            console.error('Error loading plugins for filter:', error);
        }
    }

    // Event listeners
    function setupEventListeners() {
        const refreshBtn = document.getElementById('refresh-history-btn');
        if (refreshBtn) {
            refreshBtn.addEventListener('click', () => {
                loadHistory();
            });
        }

        const clearBtn = document.getElementById('clear-history-btn');
        if (clearBtn) {
            clearBtn.addEventListener('click', async () => {
                if (confirm('Are you sure you want to clear the operation history? This cannot be undone.')) {
                    try {
                        const response = await fetch('/api/v3/plugins/operation/history', { method: 'DELETE' });
                        const data = await response.json();
                        if (data.status === 'success') {
                            allHistory = [];
                            applyFilters();
                        } else {
                            showError(data.message || 'Failed to clear history');
                        }
                    } catch (error) {
                        showError('Error clearing history');
                    }
                }
            });
        }

        const prevBtn = document.getElementById('history-prev-btn');
        if (prevBtn) {
            prevBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderHistory();
                }
            });
        }

        const nextBtn = document.getElementById('history-next-btn');
        if (nextBtn) {
            nextBtn.addEventListener('click', () => {
                const start = (currentPage - 1) * pageSize;
                const end = Math.min(start + pageSize, filteredHistory.length);
                if (end < filteredHistory.length) {
                    currentPage++;
                    renderHistory();
                }
            });
        }

        // Filter change listeners
        ['history-plugin-filter', 'history-type-filter', 'history-status-filter'].forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.addEventListener('change', () => {
                    currentPage = 1;
                    applyFilters();
                });
            }
        });

        const searchInput = document.getElementById('history-search');
        if (searchInput) {
            let searchTimeout;
            searchInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    currentPage = 1;
                    applyFilters();
                }, 300);
            });
        }
    }

    // Initialize
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            populatePluginFilter();
            loadHistory();
        });
    } else {
        setupEventListeners();
        populatePluginFilter();
        loadHistory();
    }
})();
</script>
