<div class="card shadow-sm" x-data="wifiSetup()" x-init="init(); loadStatus()">
    <!-- Captive Portal Banner (shown when AP mode is active) -->
    <div x-show="status.ap_mode_active"
         class="alert alert-info d-flex align-items-start m-3 mb-0"
         x-cloak>
        <i class="fas fa-info-circle me-3 mt-1"></i>
        <div>
            <h6 class="alert-heading mb-1">Captive Portal Active</h6>
            <p class="mb-0 small">
                You're connected to the LEDMatrix-Setup network. Configure your WiFi connection below to connect to your home network.
            </p>
        </div>
    </div>

    <div class="card-header">
        <h2 class="card-title mb-1">
            <i class="fas fa-wifi me-2"></i>WiFi Setup
        </h2>
        <p class="card-subtitle text-muted small mb-0">Configure WiFi connection for your Raspberry Pi. Access point mode will automatically activate when no WiFi connection is detected.</p>
    </div>

    <div class="card-body">
        <!-- Current WiFi Status -->
        <div class="card bg-light mb-4">
            <div class="card-body">
                <h6 class="card-title mb-3">Current Status</h6>
                <div class="row g-3">
                    <div class="col-12 col-md-6">
                        <span class="small text-muted">Connection:</span>
                        <span x-text="status.connected ? 'Connected' : 'Not Connected'"
                              :class="status.connected ? 'text-success fw-medium' : 'text-danger fw-medium'"
                              class="ms-2"></span>
                    </div>
                    <div class="col-12 col-md-6" x-show="status.connected">
                        <span class="small text-muted">Network:</span>
                        <span class="ms-2 fw-medium" x-text="status.ssid || 'Unknown'"></span>
                    </div>
                    <div class="col-12 col-md-6" x-show="status.connected">
                        <span class="small text-muted">IP Address:</span>
                        <span class="ms-2 fw-medium" x-text="status.ip_address || 'Unknown'"></span>
                    </div>
                    <div class="col-12 col-md-6" x-show="status.connected">
                        <span class="small text-muted">Signal:</span>
                        <span class="ms-2 fw-medium" x-text="status.signal + '%'"></span>
                    </div>
                    <div class="col-12 col-md-6">
                        <span class="small text-muted">AP Mode:</span>
                        <span x-text="status.ap_mode_active ? 'Active' : 'Inactive'"
                              :class="status.ap_mode_active ? 'text-success fw-medium' : 'text-muted fw-medium'"
                              class="ms-2"></span>
                    </div>
                </div>
                <div class="mt-3 d-flex gap-2">
                    <button @click="loadStatus()"
                            class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-sync-alt me-1"></i>Refresh Status
                    </button>
                    <button x-show="status.connected"
                            @click="disconnectFromNetwork()"
                            :disabled="disconnecting"
                            class="btn btn-outline-danger btn-sm"
                            x-cloak>
                        <i class="fas fa-unlink" :class="disconnecting ? 'fa-spin' : ''"></i>
                        <span class="ms-1" x-text="disconnecting ? 'Disconnecting...' : 'Disconnect'"></span>
                    </button>
                </div>
            </div>
        </div>

        <!-- WiFi Connection Form -->
        <div class="mb-4">
            <h6 class="fw-medium mb-3">Connect to WiFi Network</h6>

            <!-- Network Selection -->
            <div class="mb-3">
                <label for="wifi-ssid" class="form-label fw-medium">
                    Step 1: Select Network
                </label>
                <div class="d-flex gap-2">
                    <select id="wifi-ssid"
                            x-model="selectedSSID"
                            @change="manualSSID = ''"
                            class="form-select flex-grow-1">
                        <option value="">-- Select a network --</option>
                        <template x-for="(network, index) in networks" :key="index">
                            <option :value="network.ssid" x-text="network.ssid + ' (' + network.signal + '% - ' + network.security + ')'"></option>
                        </template>
                    </select>
                    <!-- Debug: Show network count -->
                    <div x-show="networks.length > 0" class="small text-muted align-self-center px-2" x-cloak>
                        (<span x-text="networks.length"></span> networks)
                    </div>
                    <button @click="scanNetworks()"
                            :disabled="scanning"
                            class="btn btn-primary">
                        <i class="fas fa-sync-alt" :class="scanning ? 'fa-spin' : ''"></i>
                        <span class="ms-2">Scan</span>
                    </button>
                </div>
                <div class="form-text">Scan for available networks or manually enter SSID below.</div>
                <!-- Show selected network -->
                <div x-show="selectedSSID" class="alert alert-info py-2 mt-2 small" x-cloak>
                    <i class="fas fa-check-circle me-2"></i>
                    <span class="fw-medium">Selected:</span> <span x-text="selectedSSID"></span>
                </div>
            </div>

            <!-- Manual SSID Entry -->
            <div class="mb-3">
                <label for="manual-ssid" class="form-label fw-medium">
                    Or Enter SSID Manually
                </label>
                <input type="text"
                       id="manual-ssid"
                       x-model="manualSSID"
                       @input="selectedSSID = ''; selectedSSID = $event.target.value"
                       placeholder="Enter network name"
                       class="form-control">
            </div>

            <!-- Password -->
            <div class="mb-3">
                <label for="wifi-password" class="form-label fw-medium">
                    Step 2: Enter Password
                </label>
                <input type="password"
                       id="wifi-password"
                       x-model="password"
                       placeholder="Enter password (leave empty for open networks)"
                       class="form-control">
                <div class="form-text">
                    <i class="fas fa-info-circle me-1"></i>
                    Enter the WiFi password. Leave empty if the network is open (no password required).
                </div>
            </div>

            <!-- Connect Button -->
            <div>
                <button @click="connectToNetwork()"
                        :disabled="connecting || (!selectedSSID && !manualSSID)"
                        class="btn btn-success">
                    <i class="fas fa-plug" :class="connecting ? 'fa-spin' : ''"></i>
                    <span class="ms-2" x-text="connecting ? 'Connecting...' : 'Step 3: Connect'"></span>
                </button>
            </div>
        </div>

        <!-- AP Mode Controls -->
        <hr>
        <div class="mt-4">
            <h6 class="fw-medium mb-3">Access Point Mode</h6>
            <p class="small text-muted mb-3">
                Access point mode allows you to connect to the Raspberry Pi even when it's not connected to WiFi.
            </p>

            <!-- Auto-Enable Toggle -->
            <div class="card bg-light mb-3">
                <div class="card-body py-3">
                    <div class="d-flex align-items-start justify-content-between gap-3">
                        <div class="flex-grow-1">
                            <label class="form-label fw-medium mb-1">Auto-Enable AP Mode</label>
                            <p class="form-text mb-0">
                                When enabled, AP mode will automatically activate when both WiFi and Ethernet are disconnected.
                                When disabled, AP mode must be manually enabled.
                            </p>
                        </div>
                        <div class="flex-shrink-0">
                            <div class="form-check form-switch">
                                <input type="checkbox"
                                       class="form-check-input"
                                       role="switch"
                                       :checked="status.auto_enable_ap_mode"
                                       @change="toggleAutoEnable(!status.auto_enable_ap_mode)">
                            </div>
                        </div>
                    </div>
                    <div class="mt-2 small" :class="status.auto_enable_ap_mode ? 'text-success' : 'text-muted'">
                        <span x-text="status.auto_enable_ap_mode ? 'Auto-enable is ON' : 'Auto-enable is OFF'"></span>
                    </div>
                </div>
            </div>

            <!-- Manual AP Mode Controls -->
            <div class="d-flex gap-2">
                <button @click="enableAPMode()"
                        :disabled="apOperating || status.ap_mode_active"
                        class="btn btn-primary">
                    <i class="fas fa-broadcast-tower" :class="apOperating ? 'fa-spin' : ''"></i>
                    <span class="ms-2">Enable AP Mode</span>
                </button>
                <button @click="disableAPMode()"
                        :disabled="apOperating || !status.ap_mode_active"
                        class="btn btn-danger">
                    <i class="fas fa-stop" :class="apOperating ? 'fa-spin' : ''"></i>
                    <span class="ms-2">Disable AP Mode</span>
                </button>
            </div>
        </div>

        <!-- Messages -->
        <div x-show="message"
             x-text="message"
             :class="messageType === 'error' ? 'alert alert-danger' : 'alert alert-success'"
             class="mt-4"
             x-cloak></div>
    </div>
</div>

<script>
// Ensure wifiSetup is available globally for Alpine.js
function wifiSetup() {
    return {
        status: {
            connected: false,
            ssid: null,
            ip_address: null,
            signal: 0,
            ap_mode_active: false,
            auto_enable_ap_mode: true  // Default: true (safe due to grace period)
        },
        networks: [],
        selectedSSID: '',
        manualSSID: '',
        password: '',
        scanning: false,
        connecting: false,
        disconnecting: false,
        apOperating: false,
        message: '',
        messageType: 'success',

        init() {
            // Watch networks array and update select when it changes
            this.$watch('networks', () => {
                this.$nextTick(() => {
                    this.updateSelectOptions();
                });
            });
        },

        updateSelectOptions() {
            // Fallback method to manually update select if x-for doesn't work
            const select = document.getElementById('wifi-ssid');
            if (!select) return;

            // Clear existing options except the first one
            while (select.options.length > 1) {
                select.remove(1);
            }

            // Add network options
            this.networks.forEach(network => {
                const option = document.createElement('option');
                option.value = network.ssid;
                option.textContent = `${network.ssid} (${network.signal}% - ${network.security})`;
                select.appendChild(option);
            });
        },

        async loadStatus() {
            try {
                const response = await fetch('/api/v3/wifi/status');
                const data = await response.json();
                if (data.status === 'success') {
                    this.status = data.data;
                } else {
                    this.showMessage(data.message, 'error');
                }
            } catch (error) {
                this.showMessage('Failed to load WiFi status: ' + error.message, 'error');
            }
        },

        async scanNetworks() {
            this.scanning = true;
            this.message = '';
            try {
                const response = await fetch('/api/v3/wifi/scan');
                const data = await response.json();
                console.log('WiFi scan response:', data); // Debug log
                if (data.status === 'success') {
                    // Ensure data.data is an array
                    const networksArray = Array.isArray(data.data) ? data.data : [];
                    console.log('WiFi scan found networks:', networksArray.length); // Debug log

                    // Set the networks array - Alpine.js will automatically update the select dropdown via x-for
                    this.networks = networksArray;

                    if (networksArray.length > 0) {
                        this.showMessage(`Found ${networksArray.length} networks`, 'success');
                    } else {
                        this.showMessage('No networks found. Make sure WiFi is enabled and try again.', 'warning');
                    }
                } else {
                    this.showMessage(data.message || 'Failed to scan networks', 'error');
                }
            } catch (error) {
                console.error('WiFi scan error:', error); // Debug log
                this.showMessage('Failed to scan networks: ' + error.message, 'error');
            } finally {
                this.scanning = false;
            }
        },

        async connectToNetwork() {
            const ssid = this.selectedSSID || this.manualSSID;
            if (!ssid || ssid.trim() === '') {
                this.showMessage('Please select or enter a network SSID', 'error');
                return;
            }

            // Check if we're switching networks
            const isSwitching = this.status.connected &&
                               this.status.ssid &&
                               this.status.ssid !== ssid.trim();

            if (isSwitching) {
                this.showMessage(`Switching from ${this.status.ssid} to ${ssid.trim()}...`, 'info');
            }

            this.connecting = true;
            this.message = '';
            try {
                const response = await fetch('/api/v3/wifi/connect', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ssid: ssid.trim(),
                        password: this.password || ''
                    })
                });

                // Check if response is ok before parsing JSON
                if (!response.ok) {
                    // Try to parse error message from response
                    let errorMessage = `Server error: ${response.status} ${response.statusText}`;
                    try {
                        const errorData = await response.json();
                        if (errorData.message) {
                            errorMessage = errorData.message;
                        }
                    } catch (e) {
                        // If we can't parse JSON, use the status text
                    }
                    this.showMessage(errorMessage, 'error');
                    return;
                }

                const data = await response.json();
                if (data.status === 'success') {
                    const successMsg = isSwitching
                        ? `Successfully switched to ${ssid.trim()}`
                        : data.message;
                    this.showMessage(successMsg, 'success');
                    // Clear form
                    this.password = '';
                    this.selectedSSID = '';
                    this.manualSSID = '';
                    // Reload status multiple times to catch connection updates
                    setTimeout(() => this.loadStatus(), 2000);
                    setTimeout(() => this.loadStatus(), 5000);
                    setTimeout(() => this.loadStatus(), 10000);
                } else {
                    this.showMessage(data.message || 'Failed to connect to network', 'error');
                }
            } catch (error) {
                console.error('WiFi connect error:', error);
                this.showMessage('Failed to connect: ' + error.message, 'error');
            } finally {
                this.connecting = false;
            }
        },

        async disconnectFromNetwork() {
            if (!this.status.connected) {
                this.showMessage('Not connected to any network', 'warning');
                return;
            }

            this.disconnecting = true;
            this.message = '';
            try {
                const response = await fetch('/api/v3/wifi/disconnect', {
                    method: 'POST'
                });

                // Check if response is ok before parsing JSON
                if (!response.ok) {
                    let errorMessage = `Server error: ${response.status} ${response.statusText}`;
                    try {
                        const errorData = await response.json();
                        if (errorData.message) {
                            errorMessage = errorData.message;
                        }
                    } catch (e) {
                        // If we can't parse JSON, use the status text
                    }
                    this.showMessage(errorMessage, 'error');
                    return;
                }

                const data = await response.json();
                if (data.status === 'success') {
                    this.showMessage(data.message, 'success');
                    // Reload status after a delay to show updated state
                    setTimeout(() => this.loadStatus(), 2000);
                } else {
                    this.showMessage(data.message || 'Failed to disconnect from network', 'error');
                }
            } catch (error) {
                console.error('WiFi disconnect error:', error);
                this.showMessage('Failed to disconnect: ' + error.message, 'error');
            } finally {
                this.disconnecting = false;
            }
        },

        async enableAPMode() {
            this.apOperating = true;
            this.message = '';
            try {
                const response = await fetch('/api/v3/wifi/ap/enable', {
                    method: 'POST'
                });
                const data = await response.json();
                if (data.status === 'success') {
                    this.showMessage(data.message, 'success');
                    setTimeout(() => this.loadStatus(), 1000);
                } else {
                    this.showMessage(data.message, 'error');
                }
            } catch (error) {
                this.showMessage('Failed to enable AP mode: ' + error.message, 'error');
            } finally {
                this.apOperating = false;
            }
        },

        async disableAPMode() {
            this.apOperating = true;
            this.message = '';
            try {
                const response = await fetch('/api/v3/wifi/ap/disable', {
                    method: 'POST'
                });
                const data = await response.json();
                if (data.status === 'success') {
                    this.showMessage(data.message, 'success');
                    setTimeout(() => this.loadStatus(), 1000);
                } else {
                    this.showMessage(data.message, 'error');
                }
            } catch (error) {
                this.showMessage('Failed to disable AP mode: ' + error.message, 'error');
            } finally {
                this.apOperating = false;
            }
        },

        async toggleAutoEnable(enabled) {
            try {
                const response = await fetch('/api/v3/wifi/ap/auto-enable', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        auto_enable_ap_mode: enabled
                    })
                });
                const data = await response.json();
                if (data.status === 'success') {
                    this.status.auto_enable_ap_mode = enabled;
                    this.showMessage(
                        enabled
                            ? 'Auto-enable AP mode is now enabled'
                            : 'Auto-enable AP mode is now disabled',
                        'success'
                    );
                } else {
                    this.showMessage(data.message, 'error');
                    // Revert toggle on error
                    this.status.auto_enable_ap_mode = !enabled;
                }
            } catch (error) {
                this.showMessage('Failed to update auto-enable setting: ' + error.message, 'error');
                // Revert toggle on error
                this.status.auto_enable_ap_mode = !enabled;
            }
        },

        showMessage(msg, type = 'success') {
            this.message = msg;
            this.messageType = type;
            if (type === 'success') {
                setTimeout(() => this.message = '', 5000);
            }
        }
    }
};

// Also make it available as a global function for Alpine.js
if (typeof window !== 'undefined') {
    window.wifiSetup = wifiSetup;
}
</script>
