<div>
    <!-- Header -->
    <div class="d-flex align-items-center justify-content-between pb-3 mb-3 border-bottom">
        <div>
            <h3 class="h5 fw-bold mb-1">
                <i class="fas fa-star text-warning me-2"></i>{{ app_name }}
            </h3>
            <p class="small text-muted mb-0">Starlark App &mdash; ID: {{ app_id }}</p>
        </div>
        <div class="d-flex align-items-center gap-2">
            <span class="badge bg-warning text-dark"><i class="fas fa-star me-1"></i>Starlark</span>
            {% if app_enabled %}
                <span class="badge bg-success">Enabled</span>
            {% else %}
                <span class="badge bg-danger">Disabled</span>
            {% endif %}
        </div>
    </div>

    <!-- Status -->
    <div class="card bg-light mb-3">
        <div class="card-body">
            <h6 class="fw-semibold mb-3">Status</h6>
            <div class="row g-3 small">
                <div class="col-6 col-md-3">
                    <span class="text-muted">Frames:</span>
                    <span class="fw-medium ms-1">{{ frame_count if has_frames else 'Not rendered' }}</span>
                </div>
                <div class="col-6 col-md-3">
                    <span class="text-muted">Render Interval:</span>
                    <span class="fw-medium ms-1">{{ render_interval }}s</span>
                </div>
                <div class="col-6 col-md-3">
                    <span class="text-muted">Display Duration:</span>
                    <span class="fw-medium ms-1">{{ display_duration }}s</span>
                </div>
                <div class="col-6 col-md-3">
                    <span class="text-muted">Last Render:</span>
                    <span class="fw-medium ms-1" id="starlark-last-render">{{ last_render_time }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Actions -->
    <div class="d-flex gap-2 mb-3">
        <button onclick="forceRenderStarlarkApp('{{ app_id }}')"
                class="btn btn-primary btn-sm">
            <i class="fas fa-sync me-1"></i>Force Render
        </button>
        <button onclick="toggleStarlarkApp('{{ app_id }}', {{ 'false' if app_enabled else 'true' }})"
                class="btn btn-sm {{ 'btn-danger' if app_enabled else 'btn-success' }}">
            <i class="fas {{ 'fa-toggle-off' if app_enabled else 'fa-toggle-on' }} me-1"></i>
            {{ 'Disable' if app_enabled else 'Enable' }}
        </button>
    </div>

    <!-- Configuration -->
    <div class="card mb-3">
        <div class="card-body">
            <h6 class="fw-semibold mb-3">Timing Settings</h6>
            <div id="starlark-config-form">
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label fw-medium">Render Interval (seconds)</label>
                            <input type="number" min="10" max="86400" step="1"
                                   class="form-control form-control-sm"
                                   value="{{ render_interval }}"
                                   data-starlark-config="render_interval">
                            <div class="form-text">How often the app re-renders (fetches new data)</div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label fw-medium">Display Duration (seconds)</label>
                            <input type="number" min="1" max="3600" step="1"
                                   class="form-control form-control-sm"
                                   value="{{ display_duration }}"
                                   data-starlark-config="display_duration">
                            <div class="form-text">How long the app displays before rotating</div>
                        </div>
                    </div>
                </div>

                {# ── Schema-driven App Settings ── #}
                {% set fields = [] %}
                {% if schema %}
                    {% if schema.fields is defined %}
                        {% set fields = schema.fields %}
                    {% elif schema.schema is defined and schema.schema is iterable and schema.schema is not string %}
                        {% set fields = schema.schema %}
                    {% endif %}
                {% endif %}

                {% if fields %}
                <hr class="my-3">
                <h6 class="fw-semibold mb-3">App Settings</h6>

                {% for field in fields %}
                    {% if field.typeOf is defined and field.id is defined %}
                    {% set field_id = field.id %}
                    {% set field_type = field.typeOf %}
                    {% set field_name = field.name or field_id %}
                    {% set field_desc = field.desc or '' %}
                    {% set field_default = field.default if field.default is defined else '' %}
                    {% set current_val = config.get(field_id, field_default) if config else field_default %}

                    {# ── text ── #}
                    {% if field_type == 'text' %}
                    <div class="mb-3">
                        <label class="form-label fw-medium">{{ field_name }}</label>
                        <input type="text"
                               class="form-control form-control-sm"
                               value="{{ current_val }}"
                               placeholder="{{ field_desc }}"
                               data-starlark-config="{{ field_id }}">
                        {% if field_desc %}
                        <div class="form-text">{{ field_desc }}</div>
                        {% endif %}
                    </div>

                    {# ── dropdown ── #}
                    {% elif field_type == 'dropdown' %}
                    <div class="mb-3">
                        <label class="form-label fw-medium">{{ field_name }}</label>
                        <select class="form-select form-select-sm"
                                data-starlark-config="{{ field_id }}">
                            {% for opt in (field.options or []) %}
                            <option value="{{ opt.value }}" {{ 'selected' if current_val|string == opt.value|string else '' }}>
                                {{ opt.display }}
                            </option>
                            {% endfor %}
                        </select>
                        {% if field_desc %}
                        <div class="form-text">{{ field_desc }}</div>
                        {% endif %}
                    </div>

                    {# ── toggle ── #}
                    {% elif field_type == 'toggle' %}
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input type="checkbox"
                                   class="form-check-input"
                                   data-starlark-config="{{ field_id }}"
                                   data-starlark-type="toggle"
                                   {{ 'checked' if (current_val is sameas true or current_val|string|lower in ('true', '1', 'yes')) else '' }}>
                            <label class="form-check-label fw-medium">{{ field_name }}</label>
                        </div>
                        {% if field_desc %}
                        <div class="form-text ms-4">{{ field_desc }}</div>
                        {% endif %}
                    </div>

                    {# ── color ── #}
                    {% elif field_type == 'color' %}
                    <div class="mb-3">
                        <label class="form-label fw-medium">{{ field_name }}</label>
                        <div class="d-flex align-items-center gap-2">
                            <input type="color"
                                   class="form-control form-control-color"
                                   value="{{ current_val or '#FFFFFF' }}"
                                   data-starlark-color-picker="{{ field_id }}"
                                   oninput="this.closest('div').parentElement.querySelector('[data-starlark-config={{ field_id }}]').value = this.value">
                            <input type="text"
                                   class="form-control form-control-sm flex-grow-1 font-monospace"
                                   value="{{ current_val or '#FFFFFF' }}"
                                   placeholder="#RRGGBB"
                                   data-starlark-config="{{ field_id }}"
                                   oninput="var cp = this.closest('div').parentElement.querySelector('[data-starlark-color-picker={{ field_id }}]'); if(cp && this.value.match(/^#[0-9a-fA-F]{6}$/)) cp.value = this.value;">
                        </div>
                        {% if field_desc %}
                        <div class="form-text">{{ field_desc }}</div>
                        {% endif %}
                    </div>

                    {# ── datetime ── #}
                    {% elif field_type == 'datetime' %}
                    <div class="mb-3">
                        <label class="form-label fw-medium">{{ field_name }}</label>
                        <input type="datetime-local"
                               class="form-control form-control-sm"
                               value="{{ current_val }}"
                               data-starlark-config="{{ field_id }}">
                        {% if field_desc %}
                        <div class="form-text">{{ field_desc }}</div>
                        {% endif %}
                    </div>

                    {# ── location (mini-form) ── #}
                    {% elif field_type == 'location' %}
                    <div class="mb-3" data-starlark-location-group="{{ field_id }}" data-starlark-location-value="{{ current_val }}">
                        <label class="form-label fw-medium">{{ field_name }}</label>
                        <div class="row g-2">
                            <div class="col-md-4">
                                <input type="number" step="any" min="-90" max="90"
                                       class="form-control form-control-sm"
                                       placeholder="Latitude"
                                       data-starlark-location-field="{{ field_id }}"
                                       data-starlark-location-key="lat">
                            </div>
                            <div class="col-md-4">
                                <input type="number" step="any" min="-180" max="180"
                                       class="form-control form-control-sm"
                                       placeholder="Longitude"
                                       data-starlark-location-field="{{ field_id }}"
                                       data-starlark-location-key="lng">
                            </div>
                            <div class="col-md-4">
                                <input type="text"
                                       class="form-control form-control-sm"
                                       placeholder="Timezone (e.g. America/New_York)"
                                       data-starlark-location-field="{{ field_id }}"
                                       data-starlark-location-key="timezone">
                            </div>
                        </div>
                        {% if field_desc %}
                        <div class="form-text">{{ field_desc }}</div>
                        {% endif %}
                    </div>

                    {# ── oauth2 (unsupported) ── #}
                    {% elif field_type == 'oauth2' %}
                    <div class="mb-3">
                        <label class="form-label fw-medium">{{ field_name }}</label>
                        <div class="alert alert-warning small py-2" data-starlark-unsupported>
                            <i class="fas fa-exclamation-triangle me-1"></i>
                            This app requires OAuth2 authentication, which is not supported in standalone mode.
                        </div>
                        {% if field_desc %}
                        <div class="form-text">{{ field_desc }}</div>
                        {% endif %}
                    </div>

                    {# ── photo_select (unsupported) ── #}
                    {% elif field_type == 'photo_select' %}
                    <div class="mb-3">
                        <label class="form-label fw-medium">{{ field_name }}</label>
                        <div class="alert alert-warning small py-2" data-starlark-unsupported>
                            <i class="fas fa-exclamation-triangle me-1"></i>
                            Photo upload is not supported in this interface.
                        </div>
                    </div>

                    {# ── generated (hidden meta-field, skip) ── #}
                    {% elif field_type == 'generated' %}
                        {# Invisible — generated fields are handled server-side by Pixlet #}

                    {# ── typeahead / location_based (text fallback with note) ── #}
                    {% elif field_type in ('typeahead', 'location_based') %}
                    <div class="mb-3">
                        <label class="form-label fw-medium">{{ field_name }}</label>
                        <input type="text"
                               class="form-control form-control-sm"
                               value="{{ current_val }}"
                               placeholder="{{ field_desc }}"
                               data-starlark-config="{{ field_id }}">
                        <div class="form-text text-warning">
                            <i class="fas fa-info-circle me-1"></i>
                            This field normally uses autocomplete which requires a Pixlet server. Enter the value manually.
                        </div>
                        {% if field_desc %}
                        <div class="form-text">{{ field_desc }}</div>
                        {% endif %}
                    </div>

                    {# ── unknown type (text fallback) ── #}
                    {% else %}
                    <div class="mb-3">
                        <label class="form-label fw-medium">{{ field_name }}</label>
                        <input type="text"
                               class="form-control form-control-sm"
                               value="{{ current_val }}"
                               placeholder="{{ field_desc }}"
                               data-starlark-config="{{ field_id }}">
                        {% if field_desc %}
                        <div class="form-text">{{ field_desc }}</div>
                        {% endif %}
                    </div>
                    {% endif %}

                    {% endif %}{# end field.typeOf and field.id check #}
                {% endfor %}

                {# Also show any config keys NOT in the schema (user-added or legacy) #}
                {% if config %}
                    {% set schema_ids = [] %}
                    {% for f in fields %}
                        {% if f.id is defined %}
                            {% if schema_ids.append(f.id) %}{% endif %}
                        {% endif %}
                    {% endfor %}
                    {% for key, value in config.items() %}
                        {% if key not in ('render_interval', 'display_duration') and key not in schema_ids %}
                        <div class="mb-3">
                            <label class="form-label fw-medium">{{ key }} <span class="small text-muted">(custom)</span></label>
                            <input type="text" class="form-control form-control-sm"
                                   value="{{ value }}"
                                   data-starlark-config="{{ key }}">
                        </div>
                        {% endif %}
                    {% endfor %}
                {% endif %}

                {# ── No schema: fall back to raw config key/value pairs ── #}
                {% elif config %}
                <hr class="my-3">
                <h6 class="fw-semibold mb-3">App Settings</h6>
                {% for key, value in config.items() %}
                    {% if key not in ('render_interval', 'display_duration') %}
                    <div class="mb-3">
                        <label class="form-label fw-medium">{{ key }}</label>
                        <input type="text" class="form-control form-control-sm"
                               value="{{ value }}"
                               data-starlark-config="{{ key }}">
                    </div>
                    {% endif %}
                {% endfor %}
                {% endif %}

                <button onclick="saveStarlarkConfig('{{ app_id }}')"
                        class="btn btn-primary btn-sm mt-2">
                    <i class="fas fa-save me-1"></i>Save Configuration
                </button>
            </div>
        </div>
    </div>
</div>

<script>
function forceRenderStarlarkApp(appId) {
    fetch('/api/v3/starlark/apps/' + encodeURIComponent(appId) + '/render', {method: 'POST'})
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.status === 'success') {
                if (typeof showNotification === 'function') {
                    showNotification('Rendered successfully! ' + (data.frame_count || 0) + ' frame(s)', 'success');
                } else {
                    alert('Rendered successfully! ' + (data.frame_count || 0) + ' frame(s)');
                }
            } else {
                var msg = 'Render failed: ' + (data.message || 'Unknown error');
                if (typeof showNotification === 'function') showNotification(msg, 'error');
                else alert(msg);
            }
        })
        .catch(function(err) {
            var msg = 'Render failed: ' + err.message;
            if (typeof showNotification === 'function') showNotification(msg, 'error');
            else alert(msg);
        });
}

function toggleStarlarkApp(appId, enabled) {
    fetch('/api/v3/starlark/apps/' + encodeURIComponent(appId) + '/toggle', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({enabled: enabled})
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.status === 'success') {
            if (typeof loadInstalledPlugins === 'function') loadInstalledPlugins();
            else if (typeof window.loadInstalledPlugins === 'function') window.loadInstalledPlugins();
            var container = document.getElementById('plugin-config-starlark:' + appId);
            if (container && window.htmx) {
                htmx.ajax('GET', '/v3/partials/plugin-config/starlark:' + encodeURIComponent(appId), {target: container, swap: 'innerHTML'});
            }
        } else {
            var msg = 'Toggle failed: ' + (data.message || 'Unknown error');
            if (typeof showNotification === 'function') showNotification(msg, 'error');
            else alert(msg);
        }
    })
    .catch(function(err) {
        var msg = 'Toggle failed: ' + err.message;
        if (typeof showNotification === 'function') showNotification(msg, 'error');
        else alert(msg);
    });
}

function saveStarlarkConfig(appId) {
    var config = {};

    // Get container to scope queries (prevents conflicts if multiple modals open)
    var container = document.getElementById('plugin-config-starlark:' + appId);
    if (!container) {
        console.error('Container not found for appId:', appId);
        return;
    }

    // Collect standard inputs (text, number, select, datetime, color text companion)
    container.querySelectorAll('[data-starlark-config]').forEach(function(input) {
        var key = input.getAttribute('data-starlark-config');
        var type = input.getAttribute('data-starlark-type');

        if (key === 'render_interval' || key === 'display_duration') {
            config[key] = parseInt(input.value, 10) || 0;
        } else if (type === 'toggle') {
            config[key] = input.checked ? 'true' : 'false';
        } else {
            config[key] = input.value;
        }
    });

    // Collect location mini-form groups
    container.querySelectorAll('[data-starlark-location-group]').forEach(function(group) {
        var fieldId = group.getAttribute('data-starlark-location-group');
        var loc = {};
        group.querySelectorAll('[data-starlark-location-field="' + fieldId + '"]').forEach(function(sub) {
            var locKey = sub.getAttribute('data-starlark-location-key');
            if (sub.value) loc[locKey] = sub.value;
        });
        if (Object.keys(loc).length > 0) {
            config[fieldId] = JSON.stringify(loc);
        }
    });

    fetch('/api/v3/starlark/apps/' + encodeURIComponent(appId) + '/config', {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(config)
    })
    .then(function(r) { return r.json(); })
    .then(function(data) {
        if (data.status === 'success') {
            if (typeof showNotification === 'function') showNotification('Configuration saved!', 'success');
            else alert('Configuration saved!');
            // Reload partial to reflect updated status
            var container = document.getElementById('plugin-config-starlark:' + appId);
            if (container && window.htmx) {
                htmx.ajax('GET', '/v3/partials/plugin-config/starlark:' + encodeURIComponent(appId), {target: container, swap: 'innerHTML'});
            }
        } else {
            var msg = 'Save failed: ' + (data.message || 'Unknown error');
            if (typeof showNotification === 'function') showNotification(msg, 'error');
            else alert(msg);
        }
    })
    .catch(function(err) {
        var msg = 'Save failed: ' + err.message;
        if (typeof showNotification === 'function') showNotification(msg, 'error');
        else alert(msg);
    });
}

// Pre-fill location fields from stored JSON config values
(function() {
    document.querySelectorAll('[data-starlark-location-group]').forEach(function(group) {
        var fieldId = group.getAttribute('data-starlark-location-group');
        // Find the hidden or stored value — look for a data attribute with the raw JSON
        var rawVal = group.getAttribute('data-starlark-location-value');
        if (!rawVal) return;
        try {
            var loc = JSON.parse(rawVal);
            group.querySelectorAll('[data-starlark-location-field="' + fieldId + '"]').forEach(function(sub) {
                var locKey = sub.getAttribute('data-starlark-location-key');
                if (loc[locKey] !== undefined) sub.value = loc[locKey];
            });
        } catch(e) { /* not valid JSON, ignore */ }
    });
})();
</script>
