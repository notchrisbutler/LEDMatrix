<div class="card shadow-sm">
    <div class="card-header">
        <h2 class="card-title h5 mb-1">General Settings</h2>
        <p class="card-text text-muted small mb-0">Configure general system settings and location information.</p>
    </div>

    <div class="card-body">
        <form hx-post="/api/v3/config/main"
              hx-ext="json-enc"
              hx-headers='{"Content-Type": "application/json"}'
              hx-swap="none"
              hx-on:htmx:after-request="
                  var xhr = event.detail.xhr;
                  var isSuccess = xhr.status >= 200 && xhr.status < 300;
                  var message = '';
                  var status = 'success';
                  try {
                      var data = JSON.parse(xhr.responseText);
                      message = data.message || '';
                      status = data.status || status;
                  } catch (e) {}
                  if (isSuccess) {
                      message = message || 'Settings saved';
                  } else {
                      message = message || 'Failed to save settings';
                      status = 'error';
                  }
                  showNotification(message, status);
              ">

            <!-- Web Display Autostart -->
            <div class="mb-3">
                <div class="form-check form-switch">
                    <input type="checkbox"
                           name="web_display_autostart"
                           value="true"
                           {% if main_config.web_display_autostart %}checked{% endif %}
                           class="form-check-input"
                           id="web_display_autostart">
                    <label class="form-check-label fw-medium" for="web_display_autostart">Web Display Autostart</label>
                </div>
                <div class="form-text">Start the web interface on boot for easier access.</div>
            </div>

            <!-- Timezone -->
            <div class="mb-3">
                <label for="timezone" class="form-label fw-medium">Timezone</label>
                <div id="timezone_container"></div>
                <div class="form-text">Select your timezone for time-based features and scheduling.</div>
            </div>
            <script>
            (function() {
                // Track if already initialized to prevent re-render
                if (window.__timezoneWidgetInitialized) return;

                function initTimezoneWidget() {
                    if (!window.LEDMatrixWidgets) { setTimeout(initTimezoneWidget, 50); return; }
                    var widget = window.LEDMatrixWidgets.get('timezone-selector');
                    if (!widget) { setTimeout(initTimezoneWidget, 50); return; }
                    var container = document.getElementById('timezone_container');
                    if (!container) return;

                    // Only render if container is empty (not already rendered)
                    if (container.children.length > 0) return;

                    widget.render(container, {
                        'x-options': { showOffset: true, placeholder: 'Select your timezone...' }
                    }, {{ (main_config.timezone or "America/Chicago")|tojson }}, {
                        fieldId: 'timezone',
                        name: 'timezone'
                    });
                    window.__timezoneWidgetInitialized = true;
                }
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', initTimezoneWidget);
                } else {
                    setTimeout(initTimezoneWidget, 50);
                }
            })();
            </script>

            <!-- Location Information -->
            <div class="row g-3 mb-3">
                <div class="col-12 col-md-4">
                    <label for="city" class="form-label fw-medium">City</label>
                    <input type="text"
                           id="city"
                           name="city"
                           value="{{ main_config.location.city or 'Dallas' }}"
                           class="form-control">
                </div>

                <div class="col-12 col-md-4">
                    <label for="state" class="form-label fw-medium">State</label>
                    <input type="text"
                           id="state"
                           name="state"
                           value="{{ main_config.location.state or 'Texas' }}"
                           class="form-control">
                </div>

                <div class="col-12 col-md-4">
                    <label for="country" class="form-label fw-medium">Country</label>
                    <input type="text"
                           id="country"
                           name="country"
                           value="{{ main_config.location.country or 'US' }}"
                           class="form-control">
                </div>
            </div>

            <!-- Plugin System Settings -->
            <hr class="my-4">
            <h3 class="h6 fw-semibold mb-1">Plugin System Settings</h3>
            <p class="text-muted small mb-3">Configure the core plugin system behavior.</p>

            <!-- Auto Discover -->
            <div class="mb-3">
                <div class="form-check form-switch">
                    <input type="checkbox"
                           name="auto_discover"
                           value="true"
                           {% if main_config.get('plugin_system', {}).get('auto_discover', True) %}checked{% endif %}
                           class="form-check-input"
                           id="auto_discover">
                    <label class="form-check-label fw-medium" for="auto_discover">Auto Discover Plugins</label>
                </div>
                <div class="form-text">Automatically discover plugins in the plugins directory on startup.</div>
            </div>

            <!-- Auto Load Enabled -->
            <div class="mb-3">
                <div class="form-check form-switch">
                    <input type="checkbox"
                           name="auto_load_enabled"
                           value="true"
                           {% if main_config.get('plugin_system', {}).get('auto_load_enabled', True) %}checked{% endif %}
                           class="form-check-input"
                           id="auto_load_enabled">
                    <label class="form-check-label fw-medium" for="auto_load_enabled">Auto Load Enabled Plugins</label>
                </div>
                <div class="form-text">Automatically load plugins that are enabled in configuration.</div>
            </div>

            <!-- Development Mode -->
            <div class="mb-3">
                <div class="form-check form-switch">
                    <input type="checkbox"
                           name="development_mode"
                           value="true"
                           {% if main_config.get('plugin_system', {}).get('development_mode', False) %}checked{% endif %}
                           class="form-check-input"
                           id="development_mode">
                    <label class="form-check-label fw-medium" for="development_mode">Development Mode</label>
                </div>
                <div class="form-text">Enable verbose logging and development features for plugin debugging.</div>
            </div>

            <!-- Plugins Directory -->
            <div class="mb-3">
                <label for="plugins_directory" class="form-label fw-medium">Plugins Directory</label>
                <input type="text"
                       id="plugins_directory"
                       name="plugins_directory"
                       value="{{ main_config.get('plugin_system', {}).get('plugins_directory', 'plugin-repos') }}"
                       placeholder="plugin-repos"
                       class="form-control">
                <div class="form-text">Directory where plugins are stored (relative to project root).</div>
            </div>

            <!-- Submit Button -->
            <div class="d-grid d-md-block mt-4">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save me-1"></i> Save General Settings
                </button>
            </div>
        </form>
    </div>
</div>
