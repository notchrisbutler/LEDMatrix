<div class="card shadow-sm">
    <div class="card-header">
        <h2 class="card-title mb-1">Display Settings</h2>
        <p class="card-subtitle text-muted small mb-0">Configure LED matrix hardware settings and display options.</p>
    </div>

    <div class="card-body">
        <form hx-post="/api/v3/config/main"
              hx-ext="json-enc"
              hx-headers='{"Content-Type": "application/json"}'
              hx-swap="none"
              hx-on:htmx:after-request="showNotification(event.detail.xhr.responseJSON?.message || 'Display settings saved', event.detail.xhr.responseJSON?.status || 'success')"
              novalidate
              onsubmit="fixInvalidNumberInputs(this); return true;">

            <!-- Hardware Settings -->
            <div class="card bg-light mb-4">
                <div class="card-body">
                    <h5 class="card-title mb-3">Hardware Configuration</h5>

                    <div class="row g-3 mb-3">
                        <div class="col-6 col-md-3">
                            <label for="rows" class="form-label fw-medium">Rows</label>
                            <input type="number"
                                   id="rows"
                                   name="rows"
                                   value="{{ main_config.display.hardware.rows or 32 }}"
                                   min="1"
                                   max="64"
                                   class="form-control">
                            <div class="form-text">Number of LED rows</div>
                        </div>

                        <div class="col-6 col-md-3">
                            <label for="cols" class="form-label fw-medium">Columns</label>
                            <input type="number"
                                   id="cols"
                                   name="cols"
                                   value="{{ main_config.display.hardware.cols or 64 }}"
                                   min="1"
                                   max="128"
                                   class="form-control">
                            <div class="form-text">Number of LED columns</div>
                        </div>

                        <div class="col-6 col-md-3">
                            <label for="chain_length" class="form-label fw-medium">Chain Length</label>
                            <input type="number"
                                   id="chain_length"
                                   name="chain_length"
                                   value="{{ main_config.display.hardware.chain_length or 2 }}"
                                   min="1"
                                   max="8"
                                   class="form-control">
                            <div class="form-text">Panels chained together</div>
                        </div>

                        <div class="col-6 col-md-3">
                            <label for="parallel" class="form-label fw-medium">Parallel</label>
                            <input type="number"
                                   id="parallel"
                                   name="parallel"
                                   value="{{ main_config.display.hardware.parallel or 1 }}"
                                   min="1"
                                   max="4"
                                   class="form-control">
                            <div class="form-text">Number of parallel chains</div>
                        </div>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-12 col-md-6">
                            <label for="brightness" class="form-label fw-medium">Brightness</label>
                            <div class="d-flex align-items-center gap-2">
                                <input type="range"
                                       id="brightness"
                                       name="brightness"
                                       value="{{ main_config.display.hardware.brightness or 95 }}"
                                       min="1"
                                       max="100"
                                       class="form-range flex-grow-1">
                                <span id="brightness-value" class="fw-medium small" style="min-width: 2rem;">{{ main_config.display.hardware.brightness or 95 }}</span>
                            </div>
                            <div class="form-text">LED brightness: <span id="brightness-display">{{ main_config.display.hardware.brightness or 95 }}</span>%</div>
                        </div>

                        <div class="col-12 col-md-6">
                            <label for="hardware_mapping" class="form-label fw-medium">Hardware Mapping</label>
                            <select id="hardware_mapping" name="hardware_mapping" class="form-select">
                                <option value="adafruit-hat-pwm" {% if main_config.display.hardware.hardware_mapping == "adafruit-hat-pwm" %}selected{% endif %}>Adafruit HAT PWM</option>
                                <option value="adafruit-hat" {% if main_config.display.hardware.hardware_mapping == "adafruit-hat" %}selected{% endif %}>Adafruit HAT</option>
                                <option value="regular" {% if main_config.display.hardware.hardware_mapping == "regular" %}selected{% endif %}>Regular</option>
                                <option value="regular-pi1" {% if main_config.display.hardware.hardware_mapping == "regular-pi1" %}selected{% endif %}>Regular Pi1</option>
                            </select>
                        </div>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-12 col-md-4">
                            <label for="led_rgb_sequence" class="form-label fw-medium">LED RGB Sequence</label>
                            <select id="led_rgb_sequence" name="led_rgb_sequence" class="form-select">
                                <option value="RGB" {% if main_config.display.hardware.get('led_rgb_sequence', 'RGB') == "RGB" %}selected{% endif %}>RGB</option>
                                <option value="RBG" {% if main_config.display.hardware.get('led_rgb_sequence', 'RGB') == "RBG" %}selected{% endif %}>RBG</option>
                                <option value="GRB" {% if main_config.display.hardware.get('led_rgb_sequence', 'RGB') == "GRB" %}selected{% endif %}>GRB</option>
                                <option value="GBR" {% if main_config.display.hardware.get('led_rgb_sequence', 'RGB') == "GBR" %}selected{% endif %}>GBR</option>
                                <option value="BRG" {% if main_config.display.hardware.get('led_rgb_sequence', 'RGB') == "BRG" %}selected{% endif %}>BRG</option>
                                <option value="BGR" {% if main_config.display.hardware.get('led_rgb_sequence', 'RGB') == "BGR" %}selected{% endif %}>BGR</option>
                            </select>
                            <div class="form-text">Color channel order for your LED panels</div>
                        </div>

                        <div class="col-12 col-md-4">
                            <label for="multiplexing" class="form-label fw-medium">Multiplexing</label>
                            <select id="multiplexing" name="multiplexing" class="form-select">
                                <option value="0" {% if main_config.display.hardware.get('multiplexing', 0)|int == 0 %}selected{% endif %}>0 - Direct</option>
                                <option value="1" {% if main_config.display.hardware.get('multiplexing', 0)|int == 1 %}selected{% endif %}>1 - Stripe</option>
                                <option value="2" {% if main_config.display.hardware.get('multiplexing', 0)|int == 2 %}selected{% endif %}>2 - Checkered</option>
                                <option value="3" {% if main_config.display.hardware.get('multiplexing', 0)|int == 3 %}selected{% endif %}>3 - Spiral</option>
                                <option value="4" {% if main_config.display.hardware.get('multiplexing', 0)|int == 4 %}selected{% endif %}>4 - ZStripe</option>
                                <option value="5" {% if main_config.display.hardware.get('multiplexing', 0)|int == 5 %}selected{% endif %}>5 - ZnMirrorZStripe</option>
                                <option value="6" {% if main_config.display.hardware.get('multiplexing', 0)|int == 6 %}selected{% endif %}>6 - Coreman</option>
                                <option value="7" {% if main_config.display.hardware.get('multiplexing', 0)|int == 7 %}selected{% endif %}>7 - Kaler2Scan</option>
                                <option value="8" {% if main_config.display.hardware.get('multiplexing', 0)|int == 8 %}selected{% endif %}>8 - ZStripeUneven</option>
                                <option value="9" {% if main_config.display.hardware.get('multiplexing', 0)|int == 9 %}selected{% endif %}>9 - P10-128x4-Z</option>
                                <option value="10" {% if main_config.display.hardware.get('multiplexing', 0)|int == 10 %}selected{% endif %}>10 - QiangLiQ8</option>
                                <option value="11" {% if main_config.display.hardware.get('multiplexing', 0)|int == 11 %}selected{% endif %}>11 - InversedZStripe</option>
                                <option value="12" {% if main_config.display.hardware.get('multiplexing', 0)|int == 12 %}selected{% endif %}>12 - P10Outdoor1R1G1B v1</option>
                                <option value="13" {% if main_config.display.hardware.get('multiplexing', 0)|int == 13 %}selected{% endif %}>13 - P10Outdoor1R1G1B v2</option>
                                <option value="14" {% if main_config.display.hardware.get('multiplexing', 0)|int == 14 %}selected{% endif %}>14 - P10Outdoor1R1G1B v3</option>
                                <option value="15" {% if main_config.display.hardware.get('multiplexing', 0)|int == 15 %}selected{% endif %}>15 - P10CoremanMapper</option>
                                <option value="16" {% if main_config.display.hardware.get('multiplexing', 0)|int == 16 %}selected{% endif %}>16 - P8Outdoor1R1G1B</option>
                                <option value="17" {% if main_config.display.hardware.get('multiplexing', 0)|int == 17 %}selected{% endif %}>17 - FlippedStripe</option>
                                <option value="18" {% if main_config.display.hardware.get('multiplexing', 0)|int == 18 %}selected{% endif %}>18 - P10-32x16-HalfScan</option>
                                <option value="19" {% if main_config.display.hardware.get('multiplexing', 0)|int == 19 %}selected{% endif %}>19 - P10-32x16-QuarterScan</option>
                                <option value="20" {% if main_config.display.hardware.get('multiplexing', 0)|int == 20 %}selected{% endif %}>20 - P3Outdoor-64x64</option>
                                <option value="21" {% if main_config.display.hardware.get('multiplexing', 0)|int == 21 %}selected{% endif %}>21 - DoubleZMultiplex</option>
                                <option value="22" {% if main_config.display.hardware.get('multiplexing', 0)|int == 22 %}selected{% endif %}>22 - P4Outdoor-80x40</option>
                            </select>
                            <div class="form-text">Multiplexing scheme for your LED panels</div>
                        </div>

                        <div class="col-12 col-md-4">
                            <label for="panel_type" class="form-label fw-medium">Panel Type</label>
                            <select id="panel_type" name="panel_type" class="form-select">
                                <option value="" {% if not main_config.display.hardware.get('panel_type', '') %}selected{% endif %}>Standard</option>
                                <option value="FM6126A" {% if main_config.display.hardware.get('panel_type', '') == "FM6126A" %}selected{% endif %}>FM6126A</option>
                                <option value="FM6127" {% if main_config.display.hardware.get('panel_type', '') == "FM6127" %}selected{% endif %}>FM6127</option>
                            </select>
                            <div class="form-text">Special panel chipset initialization</div>
                        </div>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-12 col-md-6">
                            <label for="gpio_slowdown" class="form-label fw-medium">GPIO Slowdown</label>
                            <input type="number"
                                   id="gpio_slowdown"
                                   name="gpio_slowdown"
                                   value="{{ main_config.display.runtime.gpio_slowdown or 3 }}"
                                   min="0"
                                   max="5"
                                   class="form-control">
                            <div class="form-text">GPIO slowdown factor (0-5)</div>
                        </div>

                        <div class="col-12 col-md-6">
                            <label for="scan_mode" class="form-label fw-medium">Scan Mode</label>
                            <input type="number"
                                   id="scan_mode"
                                   name="scan_mode"
                                   value="{{ main_config.display.hardware.scan_mode or 0 }}"
                                   min="0"
                                   max="1"
                                   class="form-control">
                            <div class="form-text">Scan mode for LED matrix (0-1)</div>
                        </div>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-12 col-md-6">
                            <label for="pwm_bits" class="form-label fw-medium">PWM Bits</label>
                            <input type="number"
                                   id="pwm_bits"
                                   name="pwm_bits"
                                   value="{{ main_config.display.hardware.pwm_bits or 9 }}"
                                   min="1"
                                   max="11"
                                   class="form-control">
                            <div class="form-text">PWM bits for brightness control (1-11)</div>
                        </div>

                        <div class="col-12 col-md-6">
                            <label for="pwm_dither_bits" class="form-label fw-medium">PWM Dither Bits</label>
                            <input type="number"
                                   id="pwm_dither_bits"
                                   name="pwm_dither_bits"
                                   value="{{ main_config.display.hardware.pwm_dither_bits or 1 }}"
                                   min="0"
                                   max="4"
                                   class="form-control">
                            <div class="form-text">PWM dither bits (0-4)</div>
                        </div>
                    </div>

                    <div class="row g-3">
                        <div class="col-12 col-md-6">
                            <label for="pwm_lsb_nanoseconds" class="form-label fw-medium">PWM LSB Nanoseconds</label>
                            <input type="number"
                                   id="pwm_lsb_nanoseconds"
                                   name="pwm_lsb_nanoseconds"
                                   value="{{ main_config.display.hardware.pwm_lsb_nanoseconds or 130 }}"
                                   min="50"
                                   max="500"
                                   class="form-control">
                            <div class="form-text">PWM LSB nanoseconds (50-500)</div>
                        </div>

                        <div class="col-12 col-md-6">
                            <label for="limit_refresh_rate_hz" class="form-label fw-medium">Limit Refresh Rate (Hz)</label>
                            <input type="number"
                                   id="limit_refresh_rate_hz"
                                   name="limit_refresh_rate_hz"
                                   value="{{ main_config.display.hardware.limit_refresh_rate_hz or 120 }}"
                                   min="1"
                                   max="1000"
                                   class="form-control">
                            <div class="form-text">Limit refresh rate in Hz (1-1000)</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Display Options -->
            <div class="card bg-light mb-4">
                <div class="card-body">
                    <h5 class="card-title mb-3">Display Options</h5>

                    <div class="row g-3 mb-3">
                        <div class="col-12 col-md-6">
                            <div class="form-check form-switch">
                                <input type="checkbox"
                                       class="form-check-input"
                                       id="disable_hardware_pulsing"
                                       name="disable_hardware_pulsing"
                                       value="true"
                                       {% if main_config.display.hardware.disable_hardware_pulsing %}checked{% endif %}>
                                <label class="form-check-label fw-medium" for="disable_hardware_pulsing">Disable Hardware Pulsing</label>
                            </div>
                        </div>

                        <div class="col-12 col-md-6">
                            <div class="form-check form-switch">
                                <input type="checkbox"
                                       class="form-check-input"
                                       id="inverse_colors"
                                       name="inverse_colors"
                                       value="true"
                                       {% if main_config.display.hardware.inverse_colors %}checked{% endif %}>
                                <label class="form-check-label fw-medium" for="inverse_colors">Inverse Colors</label>
                            </div>
                        </div>

                        <div class="col-12 col-md-6">
                            <div class="form-check form-switch">
                                <input type="checkbox"
                                       class="form-check-input"
                                       id="show_refresh_rate"
                                       name="show_refresh_rate"
                                       value="true"
                                       {% if main_config.display.hardware.show_refresh_rate %}checked{% endif %}>
                                <label class="form-check-label fw-medium" for="show_refresh_rate">Show Refresh Rate</label>
                            </div>
                        </div>

                        <div class="col-12 col-md-6">
                            <div class="form-check form-switch">
                                <input type="checkbox"
                                       class="form-check-input"
                                       id="use_short_date_format"
                                       name="use_short_date_format"
                                       value="true"
                                       {% if main_config.display.use_short_date_format %}checked{% endif %}>
                                <label class="form-check-label fw-medium" for="use_short_date_format">Use Short Date Format</label>
                            </div>
                        </div>
                    </div>

                    <!-- Dynamic Duration Settings -->
                    <hr>
                    <h6 class="fw-medium mb-3">Dynamic Duration</h6>
                    <div class="row g-3">
                        <div class="col-12 col-md-6">
                            <label for="max_dynamic_duration_seconds" class="form-label fw-medium">Max Dynamic Duration (seconds)</label>
                            <input type="number"
                                   id="max_dynamic_duration_seconds"
                                   name="max_dynamic_duration_seconds"
                                   value="{{ main_config.display.get('dynamic_duration', {}).get('max_duration_seconds', 180) }}"
                                   min="30"
                                   max="1800"
                                   class="form-control">
                            <div class="form-text">Maximum time plugins can extend display duration (30-1800 seconds)</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Vegas Scroll Mode Settings -->
            <div class="card bg-light mb-4">
                <div class="card-body">
                    <div class="d-flex align-items-start justify-content-between mb-3">
                        <div>
                            <h5 id="vegas_scroll_label" class="card-title">
                                <i class="fas fa-scroll me-2"></i>Vegas Scroll Mode
                            </h5>
                            <p class="small text-muted mb-0">Combine all plugin content into one continuous scrolling ticker display.</p>
                        </div>
                        <div class="form-check form-switch">
                            <input type="checkbox"
                                   class="form-check-input"
                                   id="vegas_scroll_enabled"
                                   name="vegas_scroll_enabled"
                                   value="true"
                                   aria-label="Enable Vegas Scroll Mode"
                                   {% if main_config.display.get('vegas_scroll', {}).get('enabled', false) %}checked{% endif %}>
                            <label class="form-check-label fw-medium" for="vegas_scroll_enabled">Enable</label>
                        </div>
                    </div>

                    <!-- Vegas Settings (shown when enabled) -->
                    <div id="vegas_scroll_settings" style="{% if not main_config.display.get('vegas_scroll', {}).get('enabled', false) %}display: none;{% endif %}">
                        <div class="row g-3 mb-3">
                            <div class="col-12 col-md-6">
                                <label for="vegas_scroll_speed" class="form-label fw-medium">Scroll Speed (pixels/second)</label>
                                <div class="d-flex align-items-center gap-2">
                                    <input type="range"
                                           id="vegas_scroll_speed"
                                           name="vegas_scroll_speed"
                                           value="{{ main_config.display.get('vegas_scroll', {}).get('scroll_speed', 50) }}"
                                           min="10"
                                           max="200"
                                           step="5"
                                           class="form-range flex-grow-1">
                                    <span id="vegas_scroll_speed_value" class="fw-medium small" style="min-width: 2rem;">{{ main_config.display.get('vegas_scroll', {}).get('scroll_speed', 50) }}</span>
                                </div>
                                <div class="form-text">Speed of the scrolling ticker (10-200 px/s)</div>
                            </div>

                            <div class="col-12 col-md-6">
                                <label for="vegas_separator_width" class="form-label fw-medium">Separator Width (pixels)</label>
                                <input type="number"
                                       id="vegas_separator_width"
                                       name="vegas_separator_width"
                                       value="{{ main_config.display.get('vegas_scroll', {}).get('separator_width', 32) }}"
                                       min="0"
                                       max="128"
                                       class="form-control">
                                <div class="form-text">Gap between plugin content blocks (0-128 px)</div>
                            </div>
                        </div>

                        <div class="row g-3 mb-3">
                            <div class="col-12 col-md-6">
                                <label for="vegas_target_fps" class="form-label fw-medium">Target FPS</label>
                                <select id="vegas_target_fps" name="vegas_target_fps" class="form-select">
                                    <option value="60" {% if main_config.display.get('vegas_scroll', {}).get('target_fps', 125) == 60 %}selected{% endif %}>60 FPS (Lower CPU)</option>
                                    <option value="90" {% if main_config.display.get('vegas_scroll', {}).get('target_fps', 125) == 90 %}selected{% endif %}>90 FPS (Balanced)</option>
                                    <option value="125" {% if main_config.display.get('vegas_scroll', {}).get('target_fps', 125) == 125 %}selected{% endif %}>125 FPS (Smoothest)</option>
                                </select>
                                <div class="form-text">Higher FPS = smoother scroll, more CPU usage</div>
                            </div>

                            <div class="col-12 col-md-6">
                                <label for="vegas_buffer_ahead" class="form-label fw-medium">Buffer Ahead</label>
                                <select id="vegas_buffer_ahead" name="vegas_buffer_ahead" class="form-select">
                                    <option value="1" {% if main_config.display.get('vegas_scroll', {}).get('buffer_ahead', 2) == 1 %}selected{% endif %}>1 Plugin (Less memory)</option>
                                    <option value="2" {% if main_config.display.get('vegas_scroll', {}).get('buffer_ahead', 2) == 2 %}selected{% endif %}>2 Plugins (Recommended)</option>
                                    <option value="3" {% if main_config.display.get('vegas_scroll', {}).get('buffer_ahead', 2) == 3 %}selected{% endif %}>3 Plugins (More buffer)</option>
                                </select>
                                <div class="form-text">How many plugins to pre-load ahead</div>
                            </div>
                        </div>

                        <!-- Plugin Order Section -->
                        <hr>
                        <h6 class="fw-medium mb-2">Plugin Order</h6>
                        <p class="small text-muted mb-3">Drag to reorder plugins. Uncheck to exclude from Vegas scroll.</p>
                        <div id="vegas_plugin_order" class="list-group mb-3">
                            <!-- Plugin order list will be populated by JavaScript -->
                            <p class="text-muted small fst-italic p-3">Loading plugins...</p>
                        </div>
                        <input type="hidden" id="vegas_plugin_order_value" name="vegas_plugin_order" value="{{ main_config.display.get('vegas_scroll', {}).get('plugin_order', [])|tojson }}">
                        <input type="hidden" id="vegas_excluded_plugins_value" name="vegas_excluded_plugins" value="{{ main_config.display.get('vegas_scroll', {}).get('excluded_plugins', [])|tojson }}">
                    </div>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="d-flex justify-content-end">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save me-2"></i>
                    Save Display Settings
                </button>
            </div>
        </form>
    </div>
</div>

<script>
// Update brightness display
document.getElementById('brightness').addEventListener('input', function() {
    document.getElementById('brightness-value').textContent = this.value;
    document.getElementById('brightness-display').textContent = this.value;
});

// Fix invalid number inputs function (if not already defined globally)
if (typeof window.fixInvalidNumberInputs !== 'function') {
    window.fixInvalidNumberInputs = function(form) {
        if (!form) return;
        const allInputs = form.querySelectorAll('input[type="number"]');
        allInputs.forEach(input => {
            const min = parseFloat(input.getAttribute('min'));
            const max = parseFloat(input.getAttribute('max'));
            const value = parseFloat(input.value);

            if (!isNaN(value)) {
                if (!isNaN(min) && value < min) {
                    input.value = min;
                } else if (!isNaN(max) && value > max) {
                    input.value = max;
                }
            }
        });
    };
}

// Vegas Scroll Mode Settings
(function() {
    // Escape HTML to prevent XSS
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = String(text || '');
        return div.innerHTML;
    }

    // Escape for use in HTML attributes
    function escapeAttr(text) {
        return escapeHtml(text).replace(/"/g, '&quot;').replace(/'/g, '&#39;');
    }

    // Toggle settings visibility
    const vegasEnabledCheckbox = document.getElementById('vegas_scroll_enabled');
    const vegasSettings = document.getElementById('vegas_scroll_settings');

    if (vegasEnabledCheckbox && vegasSettings) {
        vegasEnabledCheckbox.addEventListener('change', function() {
            vegasSettings.style.display = this.checked ? 'block' : 'none';
        });
    }

    // Update scroll speed display
    const scrollSpeedSlider = document.getElementById('vegas_scroll_speed');
    const scrollSpeedValue = document.getElementById('vegas_scroll_speed_value');

    if (scrollSpeedSlider && scrollSpeedValue) {
        scrollSpeedSlider.addEventListener('input', function() {
            scrollSpeedValue.textContent = this.value;
        });
    }

    // Initialize plugin order list
    function initPluginOrderList() {
        const container = document.getElementById('vegas_plugin_order');
        if (!container) return;

        // Fetch available plugins
        fetch('/api/v3/plugins/installed')
            .then(response => response.json())
            .then(data => {
                // Handle both {data: {plugins: []}} and {plugins: []} response formats
                const allPlugins = data.data?.plugins || data.plugins || [];
                if (!allPlugins || allPlugins.length === 0) {
                    container.innerHTML = '<p class="text-muted small fst-italic p-3">No plugins available</p>';
                    return;
                }

                // Get current order and exclusions
                const orderInput = document.getElementById('vegas_plugin_order_value');
                const excludedInput = document.getElementById('vegas_excluded_plugins_value');
                let currentOrder = [];
                let excluded = [];

                try {
                    currentOrder = JSON.parse(orderInput.value || '[]');
                    excluded = JSON.parse(excludedInput.value || '[]');
                } catch (e) {
                    console.error('Error parsing vegas config:', e);
                }

                // Build ordered plugin list (only enabled plugins)
                const plugins = allPlugins.filter(p => p.enabled);
                const orderedPlugins = [];

                // First add plugins in current order
                currentOrder.forEach(id => {
                    const plugin = plugins.find(p => p.id === id);
                    if (plugin) orderedPlugins.push(plugin);
                });

                // Then add remaining plugins
                plugins.forEach(plugin => {
                    if (!orderedPlugins.find(p => p.id === plugin.id)) {
                        orderedPlugins.push(plugin);
                    }
                });

                // Build HTML with display mode indicators
                let html = '';
                orderedPlugins.forEach((plugin, index) => {
                    const isExcluded = excluded.includes(plugin.id);
                    // Determine display mode (from plugin config or default)
                    const vegasMode = plugin.vegas_mode || plugin.vegas_content_type || 'fixed';
                    const modeLabels = {
                        'scroll': { label: 'Scroll', icon: 'fa-scroll', color: 'text-primary' },
                        'fixed': { label: 'Fixed', icon: 'fa-square', color: 'text-success' },
                        'static': { label: 'Static', icon: 'fa-pause', color: 'text-warning' }
                    };
                    const modeInfo = modeLabels[vegasMode] || modeLabels['fixed'];
                    // Escape plugin metadata to prevent XSS
                    const safePluginId = escapeAttr(plugin.id);
                    const safePluginName = escapeHtml(plugin.name || plugin.id);
                    html += `
                        <div class="list-group-item d-flex align-items-center vegas-plugin-item"
                             data-plugin-id="${safePluginId}" draggable="true" style="cursor: move;">
                            <i class="fas fa-grip-vertical text-muted me-3"></i>
                            <div class="form-check flex-grow-1">
                                <input type="checkbox"
                                       class="form-check-input vegas-plugin-include"
                                       ${!isExcluded ? 'checked' : ''}>
                                <label class="form-check-label fw-medium small">${safePluginName}</label>
                            </div>
                            <span class="badge bg-light ${modeInfo.color} border small" title="Vegas display mode: ${modeInfo.label}">
                                <i class="fas ${modeInfo.icon} me-1"></i>${modeInfo.label}
                            </span>
                        </div>
                    `;
                });

                container.innerHTML = html || '<p class="text-muted small fst-italic p-3">No enabled plugins</p>';

                // Setup drag and drop
                setupDragAndDrop(container);

                // Setup checkbox handlers
                container.querySelectorAll('.vegas-plugin-include').forEach(checkbox => {
                    checkbox.addEventListener('change', updatePluginConfig);
                });

                // Initialize hidden inputs with current state
                updatePluginConfig();
            })
            .catch(error => {
                console.error('Error fetching plugins:', error);
                container.innerHTML = '<p class="text-danger small p-3">Error loading plugins</p>';
            });
    }

    function setupDragAndDrop(container) {
        let draggedItem = null;

        container.querySelectorAll('.vegas-plugin-item').forEach(item => {
            item.addEventListener('dragstart', function(e) {
                draggedItem = this;
                this.style.opacity = '0.5';
                e.dataTransfer.effectAllowed = 'move';
            });

            item.addEventListener('dragend', function() {
                this.style.opacity = '1';
                draggedItem = null;
                updatePluginConfig();
            });

            item.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';

                const rect = this.getBoundingClientRect();
                const midY = rect.top + rect.height / 2;

                if (e.clientY < midY) {
                    this.style.borderTop = '2px solid #3b82f6';
                    this.style.borderBottom = '';
                } else {
                    this.style.borderBottom = '2px solid #3b82f6';
                    this.style.borderTop = '';
                }
            });

            item.addEventListener('dragleave', function() {
                this.style.borderTop = '';
                this.style.borderBottom = '';
            });

            item.addEventListener('drop', function(e) {
                e.preventDefault();
                this.style.borderTop = '';
                this.style.borderBottom = '';

                if (draggedItem && draggedItem !== this) {
                    const rect = this.getBoundingClientRect();
                    const midY = rect.top + rect.height / 2;

                    if (e.clientY < midY) {
                        container.insertBefore(draggedItem, this);
                    } else {
                        container.insertBefore(draggedItem, this.nextSibling);
                    }
                }
            });
        });
    }

    function updatePluginConfig() {
        const container = document.getElementById('vegas_plugin_order');
        const orderInput = document.getElementById('vegas_plugin_order_value');
        const excludedInput = document.getElementById('vegas_excluded_plugins_value');

        if (!container || !orderInput || !excludedInput) return;

        const order = [];
        const excluded = [];

        container.querySelectorAll('.vegas-plugin-item').forEach(item => {
            const pluginId = item.dataset.pluginId;
            const checkbox = item.querySelector('.vegas-plugin-include');

            order.push(pluginId);
            if (checkbox && !checkbox.checked) {
                excluded.push(pluginId);
            }
        });

        orderInput.value = JSON.stringify(order);
        excludedInput.value = JSON.stringify(excluded);
    }

    // Initialize on DOM ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initPluginOrderList);
    } else {
        initPluginOrderList();
    }
})();
</script>
