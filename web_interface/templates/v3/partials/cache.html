<div class="card shadow-sm">
    <div class="card-header">
        <h2 class="card-title mb-1">Cache Management</h2>
        <p class="card-subtitle text-muted small mb-0">View and manage cached API responses. Cache files help reduce API calls and improve performance.</p>
    </div>

    <div class="card-body">
        <!-- Cache Info -->
        <div id="cache-info" class="card bg-light mb-4">
            <div class="card-body d-flex align-items-center justify-content-between py-3">
                <div>
                    <p class="fw-medium mb-1 small">Cache Directory</p>
                    <p id="cache-dir" class="mb-0 small font-monospace text-muted">Loading...</p>
                </div>
                <button id="refresh-cache-btn" class="btn btn-primary btn-sm">
                    <i class="fas fa-sync-alt me-2"></i>Refresh
                </button>
            </div>
        </div>

        <!-- Cache Files Table -->
        <div class="table-responsive">
            <table class="table table-sm table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Cache Key</th>
                        <th>Age</th>
                        <th>Size</th>
                        <th>Modified</th>
                        <th class="text-end">Actions</th>
                    </tr>
                </thead>
                <tbody id="cache-files-tbody">
                    <tr>
                        <td colspan="5" class="text-center py-4 text-muted">
                            <i class="fas fa-spinner fa-spin fs-4 d-block mb-2"></i>
                            <p class="mb-0">Loading cache files...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Empty State -->
        <div id="cache-empty" class="d-none text-center py-5">
            <i class="fas fa-database fs-1 text-muted d-block mb-3"></i>
            <p class="text-muted">No cache files found</p>
            <p class="small text-muted">Cache files will appear here as plugins fetch data from APIs</p>
        </div>

        <!-- Error State -->
        <div id="cache-error" class="d-none text-center py-5">
            <i class="fas fa-exclamation-triangle fs-1 text-danger d-block mb-3"></i>
            <p class="text-danger" id="cache-error-message">Error loading cache files</p>
        </div>
    </div>
</div>

<script>
// Initialize cache management when partial loads
(function() {
    loadCacheFiles();

    // Event listeners
    document.getElementById('refresh-cache-btn').addEventListener('click', loadCacheFiles);
})();

function loadCacheFiles() {
    const tbody = document.getElementById('cache-files-tbody');
    const emptyState = document.getElementById('cache-empty');
    const errorState = document.getElementById('cache-error');
    const errorMessage = document.getElementById('cache-error-message');

    // Show loading state
    tbody.innerHTML = `
        <tr>
            <td colspan="5" class="text-center py-4 text-muted">
                <i class="fas fa-spinner fa-spin fs-4 d-block mb-2"></i>
                <p class="mb-0">Loading cache files...</p>
            </td>
        </tr>
    `;
    emptyState.classList.add('d-none');
    errorState.classList.add('d-none');

    fetch('/api/v3/cache/list')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                displayCacheFiles(data.data);
                updateCacheInfo(data.data.cache_dir);
            } else {
                showError(data.message || 'Failed to load cache files');
            }
        })
        .catch(error => {
            showError('Error loading cache files: ' + error.message);
        });
}

function displayCacheFiles(data) {
    const tbody = document.getElementById('cache-files-tbody');
    const emptyState = document.getElementById('cache-empty');
    const errorState = document.getElementById('cache-error');

    errorState.classList.add('d-none');

    if (!data.cache_files || data.cache_files.length === 0) {
        tbody.innerHTML = '';
        emptyState.classList.remove('d-none');
        return;
    }

    emptyState.classList.add('d-none');
    tbody.innerHTML = '';

    data.cache_files.forEach(cacheFile => {
        const row = document.createElement('tr');

        // Format modified time
        const modifiedDate = new Date(cacheFile.modified_datetime);
        const modifiedStr = modifiedDate.toLocaleString('en-US', {
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false
        });

        // Age badge color coding
        let ageBadgeClass = 'bg-secondary';
        if (cacheFile.age_seconds < 300) { // Less than 5 minutes
            ageBadgeClass = 'bg-success';
        } else if (cacheFile.age_seconds < 3600) { // Less than 1 hour
            ageBadgeClass = 'bg-warning text-dark';
        } else { // Older than 1 hour
            ageBadgeClass = 'bg-danger';
        }

        row.innerHTML = `
            <td>
                <div class="fw-medium font-monospace small">${escapeHtml(cacheFile.key)}</div>
                <div class="text-muted small">${escapeHtml(cacheFile.filename)}</div>
            </td>
            <td>
                <span class="badge ${ageBadgeClass}">${escapeHtml(cacheFile.age_display)}</span>
            </td>
            <td class="small text-muted">${escapeHtml(cacheFile.size_display)}</td>
            <td class="small text-muted">${escapeHtml(modifiedStr)}</td>
            <td class="text-end">
                <button onclick="deleteCacheFile('${escapeHtml(cacheFile.key)}')"
                        class="btn btn-outline-danger btn-sm"
                        title="Delete cache file">
                    <i class="fas fa-trash me-1"></i>Delete
                </button>
            </td>
        `;

        tbody.appendChild(row);
    });
}

function updateCacheInfo(cacheDir) {
    const cacheDirEl = document.getElementById('cache-dir');
    if (cacheDir) {
        cacheDirEl.textContent = cacheDir;
    } else {
        cacheDirEl.textContent = 'Not configured';
    }
}

function deleteCacheFile(key) {
    if (!confirm(`Are you sure you want to delete the cache file for "${key}"?`)) {
        return;
    }

    fetch('/api/v3/cache/delete', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ key: key })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            if (typeof showNotification !== 'undefined') {
                showNotification(data.message || 'Cache file deleted successfully', 'success');
            }
            // Reload cache files list
            loadCacheFiles();
        } else {
            if (typeof showNotification !== 'undefined') {
                showNotification(data.message || 'Failed to delete cache file', 'error');
            }
        }
    })
    .catch(error => {
        if (typeof showNotification !== 'undefined') {
            showNotification('Error deleting cache file: ' + error.message, 'error');
        }
    });
}

function showError(message) {
    const tbody = document.getElementById('cache-files-tbody');
    const errorState = document.getElementById('cache-error');
    const errorMessage = document.getElementById('cache-error-message');
    const emptyState = document.getElementById('cache-empty');

    tbody.innerHTML = '';
    emptyState.classList.add('d-none');
    errorState.classList.remove('d-none');
    errorMessage.textContent = message;
}

// Utility function to escape HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Make deleteCacheFile available globally for onclick handlers
window.deleteCacheFile = deleteCacheFile;
</script>
