<!-- System Stats Cards -->
<div class="row g-3 mb-4">
    <div class="col-6 col-lg-3">
        <div class="card h-100" style="border-left: 3px solid var(--lm-primary);">
            <div class="card-body d-flex align-items-center gap-3 py-3">
                <i class="fas fa-microchip fa-lg" style="color: var(--lm-primary);"></i>
                <div>
                    <div class="small text-muted">CPU Usage</div>
                    <div class="fw-semibold fs-5" id="cpu-usage">--%</div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-6 col-lg-3">
        <div class="card h-100" style="border-left: 3px solid var(--lm-success);">
            <div class="card-body d-flex align-items-center gap-3 py-3">
                <i class="fas fa-memory fa-lg" style="color: var(--lm-success);"></i>
                <div>
                    <div class="small text-muted">Memory Usage</div>
                    <div class="fw-semibold fs-5" id="memory-usage">--%</div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-6 col-lg-3">
        <div class="card h-100" style="border-left: 3px solid var(--lm-warning);">
            <div class="card-body d-flex align-items-center gap-3 py-3">
                <i class="fas fa-thermometer-half fa-lg" style="color: var(--lm-warning);"></i>
                <div>
                    <div class="small text-muted">CPU Temperature</div>
                    <div class="fw-semibold fs-5" id="cpu-temp">--Â°C</div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-6 col-lg-3">
        <div class="card h-100" style="border-left: 3px solid var(--lm-danger);">
            <div class="card-body d-flex align-items-center gap-3 py-3">
                <i class="fas fa-desktop fa-lg" style="color: var(--lm-danger);"></i>
                <div>
                    <div class="small text-muted">Display Status</div>
                    <div class="fw-semibold fs-5" id="display-status">Unknown</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Version Info -->
<div class="card mb-4" style="border-left: 3px solid var(--lm-primary);">
    <div class="card-body d-flex justify-content-between align-items-center py-3">
        <div class="d-flex align-items-center gap-3">
            <i class="fas fa-code-branch fa-lg" style="color: var(--lm-primary);"></i>
            <div>
                <div class="small text-muted">LEDMatrix Version</div>
                <code class="fw-semibold" id="ledmatrix-version">Loading...</code>
            </div>
        </div>
        <button onclick="checkForUpdates()" class="btn btn-sm btn-outline-primary">
            <i class="fas fa-sync-alt me-1"></i>
            Check Updates
        </button>
    </div>
</div>

<!-- Quick Actions -->
<div class="card mb-4">
    <div class="card-header">
        <h6 class="card-title mb-0"><i class="fas fa-bolt me-2"></i>Quick Actions</h6>
    </div>
    <div class="card-body">
        <div class="d-flex flex-wrap gap-2" hx-ext="json-enc">
            <button hx-post="/api/v3/system/action"
                    hx-vals='{"action": "start_display"}'
                    hx-swap="none"
                    hx-on:htmx:after-request="if (typeof showNotification !== 'undefined' && event.detail.xhr && event.detail.xhr.responseJSON) { showNotification(event.detail.xhr.responseJSON.message || 'Display started', event.detail.xhr.responseJSON.status || 'success'); }"
                    class="btn btn-success btn-sm">
                <i class="fas fa-play me-1"></i>
                Start Display
            </button>

            <button hx-post="/api/v3/system/action"
                    hx-vals='{"action": "stop_display"}'
                    hx-swap="none"
                    hx-on:htmx:after-request="if (typeof showNotification !== 'undefined' && event.detail.xhr && event.detail.xhr.responseJSON) { showNotification(event.detail.xhr.responseJSON.message || 'Display stopped', event.detail.xhr.responseJSON.status || 'success'); }"
                    class="btn btn-danger btn-sm">
                <i class="fas fa-stop me-1"></i>
                Stop Display
            </button>

            <button hx-post="/api/v3/system/action"
                    hx-vals='{"action": "git_pull"}'
                    hx-confirm="This will stash any local changes and update the code. Continue?"
                    hx-swap="none"
                    hx-on:htmx:after-request="if (typeof showNotification !== 'undefined' && event.detail.xhr && event.detail.xhr.responseJSON) { showNotification(event.detail.xhr.responseJSON.message || 'Code update completed', event.detail.xhr.responseJSON.status || 'info'); }"
                    class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-download me-1"></i>
                Update Code
            </button>

            <button hx-post="/api/v3/system/action"
                    hx-vals='{"action": "reboot_system"}'
                    hx-confirm="Are you sure you want to reboot the system?"
                    hx-swap="none"
                    hx-on:htmx:after-request="if (typeof showNotification !== 'undefined' && event.detail.xhr && event.detail.xhr.responseJSON) { showNotification(event.detail.xhr.responseJSON.message || 'System rebooting...', event.detail.xhr.responseJSON.status || 'info'); }"
                    class="btn btn-warning btn-sm">
                <i class="fas fa-power-off me-1"></i>
                Reboot System
            </button>

            <button hx-post="/api/v3/system/action"
                    hx-vals='{"action": "shutdown_system"}'
                    hx-confirm="Are you sure you want to shut down the system? This will power off the Raspberry Pi."
                    hx-swap="none"
                    hx-on:htmx:after-request="if (typeof showNotification !== 'undefined' && event.detail.xhr && event.detail.xhr.responseJSON) { showNotification(event.detail.xhr.responseJSON.message || 'System shutting down...', event.detail.xhr.responseJSON.status || 'info'); }"
                    class="btn btn-dark btn-sm">
                <i class="fas fa-power-off me-1"></i>
                Shutdown System
            </button>

            <button hx-post="/api/v3/system/action"
                    hx-vals='{"action": "restart_display_service"}'
                    hx-swap="none"
                    hx-on:htmx:after-request="if (typeof showNotification !== 'undefined' && event.detail.xhr && event.detail.xhr.responseJSON) { showNotification(event.detail.xhr.responseJSON.message || 'Display service restarted', event.detail.xhr.responseJSON.status || 'success'); }"
                    class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-redo me-1"></i>
                Restart Display Service
            </button>

            <button hx-post="/api/v3/system/action"
                    hx-vals='{"action": "restart_web_service"}'
                    hx-swap="none"
                    hx-on:htmx:after-request="if (typeof showNotification !== 'undefined' && event.detail.xhr && event.detail.xhr.responseJSON) { showNotification(event.detail.xhr.responseJSON.message || 'Web service restarted', event.detail.xhr.responseJSON.status || 'success'); }"
                    class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-redo me-1"></i>
                Restart Web Service
            </button>
        </div>
    </div>
</div>

<!-- Display Preview -->
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h6 class="card-title mb-0"><i class="fas fa-tv me-2"></i>Live Display Preview</h6>
    </div>
    <div class="card-body p-2 bg-dark">
        <div id="previewStage" class="preview-stage" style="display:none; position:relative; display:inline-block;">
            <div id="previewMeta" style="position:absolute; top:-28px; left:0; color:#ddd; font-size:12px; opacity:0.85;"></div>
            <img id="displayImage" style="image-rendering: pixelated; display: block;" alt="LED Matrix Display">
            <canvas id="ledCanvas" style="position:absolute; top:0; left:0; pointer-events:none; display:none; z-index: 10;"></canvas>
            <canvas id="gridOverlay" style="position:absolute; top:0; left:0; pointer-events:none; z-index: 20;"></canvas>
        </div>
        <div id="displayPlaceholder" class="text-center text-secondary py-5">
            <i class="fas fa-spinner fa-spin fs-1 mb-3 d-block"></i>
            <p class="mb-0">Connecting to display...</p>
        </div>
    </div>
    <div class="card-footer">
        <div class="d-flex flex-wrap align-items-center gap-3">
            <button onclick="takeScreenshot()" class="btn btn-outline-secondary btn-sm">
                <i class="fas fa-camera me-1"></i> Screenshot
            </button>

            <div class="d-flex align-items-center gap-2">
                <label for="scaleRange" class="form-label mb-0 small">Scale:</label>
                <input type="range" class="form-range" id="scaleRange" min="2" max="16" value="8" style="width: 5rem;">
                <span id="scaleValue" class="fw-medium small">8x</span>
            </div>

            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="toggleGrid">
                <label class="form-check-label small" for="toggleGrid">Show pixel grid</label>
            </div>

            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="toggleLedDots" checked>
                <label class="form-check-label small" for="toggleLedDots">LED dot mode</label>
            </div>

            <div class="d-flex align-items-center gap-2">
                <label for="dotFillRange" class="form-label mb-0 small">Dot fill:</label>
                <input type="range" class="form-range" id="dotFillRange" min="40" max="95" value="75" style="width: 4rem;">
                <span id="dotFillValue" class="fw-medium small">75%</span>
            </div>
        </div>
    </div>
</div>

<!-- Stats are updated via the global updateSystemStats function in base.html -->

<script>
// Load LEDMatrix version
(function() {
    fetch('/api/v3/system/version')
        .then(response => response.json())
        .then(data => {
            const versionEl = document.getElementById('ledmatrix-version');
            if (versionEl && data.status === 'success') {
                versionEl.textContent = data.data.version;
            }
        })
        .catch(error => {
            const versionEl = document.getElementById('ledmatrix-version');
            if (versionEl) versionEl.textContent = 'Unknown';
        });
})();

// Check for updates function
window.checkForUpdates = function() {
    const btn = event.target.closest('button');
    if (btn) {
        const originalContent = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Checking...';

        fetch('/api/v3/system/action', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ action: 'git_pull' })
        })
        .then(response => response.json())
        .then(data => {
            btn.innerHTML = originalContent;
            btn.disabled = false;

            if (data.status === 'success') {
                showNotification('Update successful: ' + (data.stdout || 'Code updated'), 'success');
                // Reload version after a short delay
                setTimeout(() => {
                    fetch('/api/v3/system/version')
                        .then(response => response.json())
                        .then(data => {
                            const versionEl = document.getElementById('ledmatrix-version');
                            if (versionEl && data.status === 'success') {
                                versionEl.textContent = data.data.version;
                            }
                        });
                }, 1000);
            } else {
                showNotification('Update failed: ' + (data.stderr || data.message || 'Unknown error'), 'error');
            }
        })
        .catch(error => {
            btn.innerHTML = originalContent;
            btn.disabled = false;
            showNotification('Error checking for updates: ' + error.message, 'error');
        });
    }
};

// Setup display preview controls (runs when this partial loads)
(function() {
    const scaleRange = document.getElementById('scaleRange');
    const scaleValue = document.getElementById('scaleValue');
    const dotFillRange = document.getElementById('dotFillRange');
    const dotFillValue = document.getElementById('dotFillValue');
    const toggleGrid = document.getElementById('toggleGrid');
    const toggleLedDots = document.getElementById('toggleLedDots');

    if (scaleRange && scaleValue) {
        scaleRange.addEventListener('input', function() {
            scaleValue.textContent = this.value + 'x';
            // Re-render the preview with new scale
            const img = document.getElementById('displayImage');
            if (img && img.src) {
                const data = {
                    image: img.src.replace('data:image/png;base64,', ''),
                    width: img.naturalWidth,
                    height: img.naturalHeight
                };
                updateDisplayPreview(data);
            }
        });
    }

    if (dotFillRange && dotFillValue) {
        dotFillRange.addEventListener('input', function() {
            dotFillValue.textContent = this.value + '%';
            renderLedDots();
        });
    }

    if (toggleGrid) {
        toggleGrid.addEventListener('change', function() {
            const canvas = document.getElementById('gridOverlay');
            const img = document.getElementById('displayImage');
            if (canvas && img && img.src) {
                const scale = parseInt(scaleRange?.value || '8');
                drawGrid(canvas, img.naturalWidth, img.naturalHeight, scale);
            }
        });
    }

    if (toggleLedDots) {
        toggleLedDots.addEventListener('change', function() {
            renderLedDots();
        });
    }
})();
</script>
